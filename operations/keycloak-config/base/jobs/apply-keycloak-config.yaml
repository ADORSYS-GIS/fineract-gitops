apiVersion: batch/v1
kind: Job
metadata:
  name: apply-keycloak-config
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    metadata:
      name: keycloak-config-cli
    spec:
      restartPolicy: OnFailure
      containers:
      - name: keycloak-config-cli
        image: adorsys/keycloak-config-cli:6.0.0
        env:
        # Keycloak Connection
        # KEYCLOAK_URL should be set via ConfigMap in environment overlays
        # Default: http://keycloak-service:8080 (internal service)
        - name: KEYCLOAK_URL
          valueFrom:
            configMapKeyRef:
              name: keycloak-config-vars
              key: keycloak-url
              optional: false
        - name: KEYCLOAK_USER
          valueFrom:
            secretKeyRef:
              name: keycloak-admin-credentials
              key: username
        - name: KEYCLOAK_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-admin-credentials
              key: password

        # Configuration
        - name: KEYCLOAK_AVAILABILITYCHECK_ENABLED
          value: "true"
        - name: KEYCLOAK_AVAILABILITYCHECK_TIMEOUT
          value: "120s"

        # Import Settings
        - name: IMPORT_FILES_LOCATIONS
          value: "/config-processed/*"  # Use processed config with substituted variables
        # IMPORT_FORCE Design Decision:
        # Set to "true" for dev to enable true GitOps (Git as source of truth)
        # Set to "false" for production to preserve manual admin changes
        #
        # RATIONALE for dev=true:
        # - Development environment where consistency matters more than manual tweaks
        # - Allows realm configuration updates via Git to automatically apply
        # - Prevents job failures when realm already exists
        # - Easier to maintain and test configuration changes
        #
        # BEHAVIOR with IMPORT_FORCE=true:
        # - Realms/clients/roles from Git will be created OR updated
        # - Existing items WILL be overwritten to match Git configuration
        # - Users are created if missing, updated if changed
        # - Client secrets will be updated (ensure they're in sync with sealed secrets)
        #
        # BEHAVIOR with IMPORT_FORCE=false (recommended for production):
        # - New realms/clients/roles from Git will be created
        # - Existing items will NOT be overwritten (manual changes preserved)
        # - Users are never overwritten (only created if missing)
        # - Allows admins to customize via Keycloak UI
        #
        # NOTE: Override per environment via kustomization.yaml patches
        - name: IMPORT_FORCE
          value: "true"
        - name: IMPORT_VALIDATE
          value: "true"
        # IMPORT_VAR_SUBSTITUTION_ENABLED Design Decision:
        # Set to "false" because we use a custom init container for variable substitution
        # RATIONALE:
        # - keycloak-config-cli's built-in substitution uses Java system properties/env vars
        # - Our init container uses envsubst for ${VAR} syntax (shell-style)
        # - This gives us more control over substitution (preprocessing step)
        # - Allows validation/debugging of processed config before import
        # - Secrets are available only in init container scope (better isolation)
        # ALTERNATIVE: Enable built-in substitution and remove init container
        # - Simpler job definition (fewer moving parts)
        # - Requires changing config syntax to match keycloak-config-cli expectations
        # - Less control over substitution process
        # CURRENT APPROACH: Manual envsubst in init container (lines 95-124)
        - name: IMPORT_VAR_SUBSTITUTION_ENABLED
          value: "false"

        # Parallelism
        - name: IMPORT_PARALLEL
          value: "false"  # Sequential import

        # Logging
        - name: LOGGING_LEVEL_ROOT
          value: "INFO"
        - name: LOGGING_LEVEL_KEYCLOAK_CONFIGCLI
          value: "DEBUG"

        # Note: Environment variables are substituted in init container
        # No need to pass them here

        volumeMounts:
        - name: keycloak-config-processed
          mountPath: /config-processed
          readOnly: false  # emptyDir needs write access

        resources:
          requests:
            memory: "256Mi"
            cpu: "50m"
          limits:
            memory: "512Mi"
            cpu: "500m"

      volumes:
      - name: keycloak-config-templates
        configMap:
          name: keycloak-realm-config
      - name: keycloak-config-processed
        emptyDir: {}  # Temporary storage for processed config

      # Wait for Keycloak to be ready
      initContainers:
      - name: substitute-variables
        # Image tag managed by Kustomize image transformers per environment
        # Default: alpine:3.20 (from environment kustomization.yaml)
        image: alpine
        securityContext:
          runAsUser: 0
          runAsNonRoot: false
        command:
        - sh
        - -c
        - |
          # Install gettext for envsubst command
          apk add --no-cache gettext

          echo "Substituting environment variables in realm configuration (includes users)..."
          envsubst < /config-templates/realm-fineract.yaml > /config-processed/realm-fineract.yaml
          echo "✓ Variable substitution complete for realm configuration"
          echo "  File size: $(wc -c < /config-processed/realm-fineract.yaml) bytes"
          echo "✓ All configuration files processed securely (sensitive data not logged)"
        env:
        # Environment-specific variables
        - name: DOMAIN
          valueFrom:
            configMapKeyRef:
              name: keycloak-config-vars
              key: domain
        - name: APPS_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: keycloak-config-vars
              key: apps-hostname
        - name: AUTH_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: keycloak-config-vars
              key: auth-hostname
        - name: SMTP_HOST
          valueFrom:
            configMapKeyRef:
              name: keycloak-config-vars
              key: smtp-host
        - name: SMTP_PORT
          valueFrom:
            configMapKeyRef:
              name: keycloak-config-vars
              key: smtp-port
        - name: SMTP_USER
          valueFrom:
            secretKeyRef:
              name: smtp-credentials
              key: username
              optional: true
        - name: SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: smtp-credentials
              key: password
              optional: true
        - name: SMTP_SSL
          value: "true"
        - name: SMTP_STARTTLS
          value: "false"
        - name: SMTP_AUTH
          value: "true"
        - name: OAUTH2_PROXY_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: oauth2-proxy-client-id
              optional: true
        - name: OAUTH2_PROXY_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: oauth2-proxy-client-secret
              optional: true
        - name: ADMIN_CLI_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: admin-cli-client-id
              optional: true
        - name: ADMIN_CLI_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: admin-cli-client-secret
              optional: true
        - name: FINERACT_API_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-api-client-id
              optional: true
        - name: FINERACT_API_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-api-client-secret
              optional: true
        - name: FINERACT_DATA_LOADER_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-id
              optional: true
        - name: FINERACT_DATA_LOADER_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-secret
              optional: true
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-default-users
              key: admin-password
              optional: true
        - name: MIFOS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-default-users
              key: mifos-password
              optional: true
        - name: LOAN_OFFICER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-default-users
              key: loan-officer-password
              optional: true
        - name: TELLER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-default-users
              key: teller-password
              optional: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        volumeMounts:
        - name: keycloak-config-templates
          mountPath: /config-templates
          readOnly: true
        - name: keycloak-config-processed
          mountPath: /config-processed

      - name: wait-for-keycloak
        image: curlimages/curl:8.4.0
        command:
        - sh
        - -c
        - |
          echo "Waiting for Keycloak to be ready..."
          MAX_RETRIES=60
          RETRY_COUNT=0

          until [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            # Check if master realm is accessible (best indicator Keycloak is ready)
            # Note: Keycloak is served from /auth path
            if curl -f -s http://keycloak-service:8080/auth/realms/master > /dev/null 2>&1; then
              echo "✓ Keycloak master realm is accessible!"
              echo "Keycloak is fully ready for realm configuration!"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Keycloak not ready yet (attempt $RETRY_COUNT/$MAX_RETRIES), waiting 5s..."
            sleep 5
          done

          echo "❌ Keycloak did not become ready within timeout"
          exit 1
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
