# Keycloak Realm Configuration for Fineract
# Managed via keycloak-config-cli
# Documentation: https://github.com/adorsys/keycloak-config-cli

realm: fineract
displayName: Fineract Banking Platform
enabled: true

# Realm Settings
internationalizationEnabled: true
supportedLocales:
  - en
  - fr
  - sw
defaultLocale: en

# Login Settings
registrationAllowed: false  # Users created by admin only
registrationEmailAsUsername: false
rememberMe: true
verifyEmail: true  # Enable email verification for security compliance
loginWithEmailAllowed: true
duplicateEmailsAllowed: false
resetPasswordAllowed: true  # Enable password reset for better user experience
editUsernameAllowed: false

# Token Settings
accessTokenLifespan: 1800  # 30 minutes (balanced for UX and security)
ssoSessionIdleTimeout: 1800  # 30 minutes (reduced for security)
ssoSessionMaxLifespan: 14400  # 4 hours (reduced for security)
offlineSessionIdleTimeout: 2592000  # 30 days
revokeRefreshToken: true
refreshTokenMaxReuse: 0
accessCodeLifespan: 60
accessCodeLifespanUserAction: 300
accessCodeLifespanLogin: 1800

# Themes - Using custom Webank theme for professional banking UI
# loginTheme: webank
# accountTheme: webank
adminTheme: keycloak
# emailTheme: webank

# Security Defenses (Enhanced for Production)
bruteForceProtected: true
permanentLockout: false
maxFailureWaitSeconds: 1800  # 30 minutes (increased)
minimumQuickLoginWaitSeconds: 60
waitIncrementSeconds: 120  # 2 minutes (increased)
quickLoginCheckMilliSeconds: 500  # Faster detection
maxDeltaTimeSeconds: 43200
failureFactor: 3  # 3 attempts (reduced from 5 for tighter security)

# Password Policy (Enhanced for Banking Security)
passwordPolicy: "hashIterations(27500) and length(12) and upperCase(1) and lowerCase(1) and digits(2) and specialChars(1) and notUsername and passwordHistory(5)"

# OAuth2 / OIDC Settings
oauth2DeviceCodeLifespan: 600
oauth2DevicePollingInterval: 5

# Clients (4 total - OAuth2 Proxy + Service Accounts)
clients:
  # 1. OAuth2 Proxy Client (Server-side for ALL web frontends)
  - clientId: "${OAUTH2_PROXY_CLIENT_ID}"
    name: Fineract OAuth2 Proxy
    description: OAuth2 Proxy - protects all web frontends with OIDC authentication
    enabled: true

    # Client Authentication
    clientAuthenticatorType: client-secret
    secret: "${OAUTH2_PROXY_CLIENT_SECRET}"  # From external secret
    protocol: openid-connect

    # Access Type - Confidential (server-side)
    publicClient: false
    bearerOnly: false
    standardFlowEnabled: true  # Authorization Code flow
    implicitFlowEnabled: false
    directAccessGrantsEnabled: false
    serviceAccountsEnabled: false

    # URLs - Handles all frontend apps
    # Uses ${APPS_HOSTNAME} variable set by environment overlay
    # This allows dev to use LoadBalancer hostname while prod/uat use custom domains
    rootUrl: "https://${APPS_HOSTNAME}"
    redirectUris:
      - "https://${APPS_HOSTNAME}/oauth2/callback"
      - "https://${APPS_HOSTNAME}/*"
    attributes:
        "post.logout.redirect.uris": "+"
    webOrigins:
      - "https://${APPS_HOSTNAME}"

    # Scopes
    fullScopeAllowed: true
    defaultClientScopes:
      - profile
      - email
      - roles
      - web-origins
      - offline_access  # Required for refresh tokens
    optionalClientScopes:
      - address
      - phone

    # Protocol Mappers for custom claims
    protocolMappers:
      - name: fineract-user-id-mapper
        protocol: openid-connect
        protocolMapper: oidc-usermodel-attribute-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          user.attribute: "fineract_user_id"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "fineract_user_id"
          jsonType.label: "String"

      - name: office-id-mapper
        protocol: openid-connect
        protocolMapper: oidc-usermodel-attribute-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          user.attribute: "office_id"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "office_id"
          jsonType.label: "String"

      - name: employee-id-mapper
        protocol: openid-connect
        protocolMapper: oidc-usermodel-attribute-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          user.attribute: "employee_id"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "employee_id"
          jsonType.label: "String"

      - name: tenant-mapper
        protocol: openid-connect
        protocolMapper: oidc-hardcoded-claim-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "tenant"
          claim.value: "default"
          jsonType.label: "String"

      - name: audience-mapper
        protocol: openid-connect
        protocolMapper: oidc-audience-mapper
        consentRequired: false
        config:
          included.client.audience: "${OAUTH2_PROXY_CLIENT_ID}"
          id.token.claim: "false"
          access.token.claim: "true"

      - name: username-in-sub
        protocol: openid-connect
        protocolMapper: oidc-usermodel-property-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          user.attribute: "username"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "sub"
          jsonType.label: "String"

      - name: realm-roles
        protocol: openid-connect
        protocolMapper: oidc-usermodel-realm-role-mapper
        consentRequired: false
        config:
          claim.name: "realm_access.roles"
          id.token.claim: "true"
          access.token.claim: "true"
          userinfo.token.claim: "true"
          multivalued: "true"



  # 2. Admin CLI (Keycloak Config CLI + User Sync)
  - clientId: "${ADMIN_CLI_CLIENT_ID}"
    name: Webank Admin CLI
    description: Keycloak configuration management and user synchronization
    enabled: true

    # Confidential service account
    publicClient: false
    clientAuthenticatorType: client-secret
    secret: "${ADMIN_CLI_SECRET}"
    protocol: openid-connect

    # Service account only (no user interaction)
    standardFlowEnabled: false
    implicitFlowEnabled: false
    directAccessGrantsEnabled: false
    serviceAccountsEnabled: true

    # Note: Realm roles for service accounts must be assigned after creation
    # via the Keycloak admin console or a separate script

    defaultClientScopes:
      - profile
      - email

  # 3. Fineract API (Generic backend service account)
  - clientId: "${FINERACT_API_CLIENT_ID}"
    name: Fineract API Service Account
    description: Generic service account for backend integrations with Fineract
    enabled: true

    # Confidential service account
    publicClient: false
    clientAuthenticatorType: client-secret
    secret: "${FINERACT_API_SECRET}"
    protocol: openid-connect

    # Service account only
    standardFlowEnabled: false
    implicitFlowEnabled: false
    directAccessGrantsEnabled: false
    serviceAccountsEnabled: true

    defaultClientScopes:
      - profile
      - email
      - roles

    # Protocol Mappers for service account tokens
    protocolMappers:
      - name: tenant-mapper
        protocol: openid-connect
        protocolMapper: oidc-hardcoded-claim-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "tenant"
          claim.value: "default"
          jsonType.label: "String"

  # 4. Fineract Data Loader (Automated data loading operations)
  - clientId: "${FINERACT_DATA_LOADER_CLIENT_ID}"
    name: Fineract Data Loader Service
    description: Service account for automated data loading jobs (system config, demo data)
    enabled: true

    # Confidential service account
    publicClient: false
    clientAuthenticatorType: client-secret
    secret: "${FINERACT_DATA_LOADER_SECRET}"  # Generated and managed externally
    protocol: openid-connect

    # Service account only (client credentials grant)
    standardFlowEnabled: false
    implicitFlowEnabled: false
    directAccessGrantsEnabled: false
    serviceAccountsEnabled: true

    # Token settings for long-running jobs
    attributes:
      access.token.lifespan: "1800"  # 30 minutes for data loading operations

    defaultClientScopes:
      - profile
      - email
      - roles

    # Protocol Mappers for service account tokens
    protocolMappers:
      - name: tenant-mapper
        protocol: openid-connect
        protocolMapper: oidc-hardcoded-claim-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "tenant"
          claim.value: "default"
          jsonType.label: "String"

      # Hardcoded 'sub' claim mapper for backward compatibility
      # Reason: Fineract expects service account requests to have 'sub=mifos'
      # for authentication and authorization. This is a legacy requirement from
      # the original Mifos authentication system that Fineract inherited.
      # The hardcoded value ensures data loading jobs are identified as system
      # operations rather than individual user actions.
      - name: mifos-sub-mapper
        protocol: openid-connect
        protocolMapper: oidc-hardcoded-claim-mapper
        consentRequired: false
        config:
          userinfo.token.claim: "true"
          id.token.claim: "true"
          access.token.claim: "true"
          claim.name: "sub"
          claim.value: "mifos"
          jsonType.label: "String"

    # Note: Realm roles for service accounts must be assigned after creation
    # via the Keycloak admin console or a separate script

  # 5. User Sync Service (User management service account)
  - clientId: "${USER_SYNC_SERVICE_CLIENT_ID}"
    name: User Sync Service
    description: Service account for user synchronization between Fineract and Keycloak
    enabled: true

    # Confidential service account
    publicClient: false
    clientAuthenticatorType: client-secret
    secret: "${USER_SYNC_SERVICE_CLIENT_SECRET}"
    protocol: openid-connect

    # Service account only (client credentials grant)
    standardFlowEnabled: false
    implicitFlowEnabled: false
    directAccessGrantsEnabled: false
    serviceAccountsEnabled: true

    defaultClientScopes:
      - profile
      - email
      - roles

# Client Scopes
clientScopes:
  - name: fineract-api
    description: Access to Fineract API
    protocol: openid-connect
    attributes:
      include.in.token.scope: "true"
      display.on.consent.screen: "true"
    protocolMappers:
      - name: fineract-roles
        protocol: openid-connect
        protocolMapper: oidc-usermodel-realm-role-mapper
        config:
          claim.name: "fineract_roles"
          jsonType.label: "String"
          multivalued: "true"
          userinfo.token.claim: "true"
          id.token.claim: "true"
          access.token.claim: "true"

# Realm Roles (Comprehensive mapping from Fineract)
# See: ROLE_MAPPING.md for complete documentation
roles:
  realm:
    - name: admin
      description: Full administrative access (Super user)
      composite: false

    - name: Admin
      description: Admin role (capitalized for frontend apps)
      composite: false

    - name: Super User
      description: Full administrative access (Fineract native role name)
      composite: false

    - name: staff
      description: Generic staff member with operational access
      composite: false

    - name: loan-officer
      description: Loan officer - create and manage loans, clients
      composite: false

    - name: teller
      description: Teller/cashier - cash transactions, deposits, withdrawals
      composite: false

    - name: accountant
      description: Accountant - financial reports, manage accounting (lowercase)
      composite: false

    - name: Accountant
      description: Accountant role (capitalized for frontend apps)
      composite: false

    - name: Supervisor Accountant
      description: Supervisor Accountant - can approve journal entries
      composite: false

    - name: Manager
      description: Manager role - can create and view entries but cannot approve
      composite: false

    - name: Viewer
      description: Viewer role - read-only access to accounting features
      composite: false

    - name: branch-manager
      description: Branch manager - manage branch operations, approve loans
      composite: true
      composites:
        realm:
          - loan-officer
          - staff

    - name: field-officer
      description: Field officer - field operations, client visits
      composite: false

    - name: operations-manager
      description: Operations manager - operational oversight
      composite: true
      composites:
        realm:
          - branch-manager
          - staff

    - name: credit-committee
      description: Credit committee member - loan approval authority
      composite: false

    - name: checker
      description: Maker-checker approval workflows
      composite: false

    - name: client
      description: Client/customer - self-service portal access
      composite: false

    - name: readonly
      description: Read-only access - view only, no modifications
      composite: false

# Groups (mapped to offices/departments)
groups:
  - name: head-office
    path: /head-office
    attributes:
      office_id: ["1"]
    realmRoles:
      - admin
      - staff

  - name: branch-managers
    path: /branch-managers
    realmRoles:
      - branch-manager
      - staff

  - name: loan-officers
    path: /loan-officers
    realmRoles:
      - loan-officer
      - staff

  - name: tellers
    path: /tellers
    realmRoles:
      - teller
      - staff

  - name: clients
    path: /clients
    realmRoles:
      - client

# Identity Providers (optional - configure if using external IdP)
identityProviders: []

# Authentication Flows - Removed (using Keycloak defaults)
# Built-in flows are automatically created by Keycloak and don't need to be defined
# in the configuration. Attempting to define them causes NullPointerException
# in keycloak-config-cli when authenticationExecutions is null.

# Required Actions (Configured for First Login Flow)
requiredActions:
  - alias: UPDATE_PASSWORD
    name: Update Password
    providerId: UPDATE_PASSWORD
    enabled: true
    defaultAction: false  # Mandatory on first login
    priority: 10

  - alias: VERIFY_EMAIL
    name: Verify Email
    providerId: VERIFY_EMAIL
    enabled: true
    defaultAction: false  # Optional
    priority: 20

  - alias: webauthn-register
    name: Webauthn Register
    providerId: webauthn-register
    enabled: true
    defaultAction: false  # Optional - users can skip registration
    priority: 30

  - alias: CONFIGURE_TOTP
    name: Configure OTP
    providerId: CONFIGURE_TOTP
    enabled: true
    defaultAction: false  # Optional fallback
    priority: 40

  - alias: UPDATE_PROFILE
    name: Update Profile
    providerId: UPDATE_PROFILE
    enabled: true
    defaultAction: false
    priority: 50

# SMTP Configuration (Email - Webank Branding)
smtpServer:
  host: "${SMTP_HOST}"
  port: "${SMTP_PORT}"
  from: "noreply@${DOMAIN}"
  fromDisplayName: "Webank - Secure Banking Platform"
  replyTo: "support@${DOMAIN}"
  replyToDisplayName: "Webank Support"
  ssl: "${SMTP_SSL:true}"
  starttls: "${SMTP_STARTTLS:false}"
  auth: "${SMTP_AUTH:true}"
  user: "${SMTP_USER}"
  password: "${SMTP_PASSWORD}"
  envelopeFrom: "noreply@${DOMAIN}"

# Event Listeners (Enhanced for Security Monitoring)
eventsEnabled: true
eventsListeners:
  - jboss-logging
  - email  # Email on critical security events
adminEventsEnabled: true
adminEventsDetailsEnabled: true

# Enabled Event Types (Security Monitoring)
enabledEventTypes:
  - LOGIN
  - LOGIN_ERROR
  - LOGOUT
  - LOGOUT_ERROR
  - REGISTER
  - REGISTER_ERROR
  - UPDATE_PASSWORD
  - UPDATE_PASSWORD_ERROR
  - UPDATE_EMAIL
  - VERIFY_EMAIL
  - REMOVE_CREDENTIAL
  - UPDATE_CREDENTIAL
  - SEND_RESET_PASSWORD
  - SEND_RESET_PASSWORD_ERROR
  - EXECUTE_ACTION_TOKEN
  - EXECUTE_ACTION_TOKEN_ERROR
  - CLIENT_LOGIN
  - CLIENT_LOGIN_ERROR
  - REFRESH_TOKEN
  - REFRESH_TOKEN_ERROR

# Attributes (Security Headers + WebAuthn Config)
attributes:
  # frontendUrl Configuration:
  # Set dynamically per environment using AUTH_HOSTNAME variable
  # This variable is substituted by the init container using envsubst
  # This must match the --hostname parameter in Keycloak deployment
  #
  # IMPORTANT: This value is critical for JWT token validation
  # - Fineract validates the 'iss' claim in JWT tokens against this URL
  # - If there's a mismatch, authentication will fail with 302 redirects
  # - Keycloak 17+ serves from root path (no /auth prefix)
  #
  # Environment-specific values (from overlays/*/kustomization.yaml):
  # - dev: Uses AUTH_HOSTNAME from environment (LoadBalancer DNS)
  # - uat: auth.uat.fineract.com
  # - production: auth.fineract.com
  frontendUrl: "https://${AUTH_HOSTNAME}"

  acr.loa.map: '{"copper": 0, "silver": 1, "gold": 2}'

  # Security Headers
  _browser_header.contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; frame-ancestors 'none';"
  _browser_header.xContentTypeOptions: "nosniff"
  _browser_header.xRobotsTag: "none"
  _browser_header.xFrameOptions: "DENY"
  _browser_header.xXSSProtection: "1; mode=block"
  _browser_header.strictTransportSecurity: "max-age=31536000; includeSubDomains"

  # WebAuthn Policy Configuration
  webAuthnPolicyRpEntityName: "Webank"
  webAuthnPolicyRpId: "${DOMAIN}"
  webAuthnPolicySignatureAlgorithms: '["ES256","RS256"]'
  webAuthnPolicyAttestationConveyancePreference: "none"
  webAuthnPolicyAuthenticatorAttachment: "cross-platform,platform"
  webAuthnPolicyRequireResidentKey: "No"
  webAuthnPolicyUserVerificationRequirement: "required"
  webAuthnPolicyCreateTimeout: 60
  webAuthnPolicyAvoidSameAuthenticatorRegister: false
  webAuthnPolicyAcceptableAaguids: '[]'  # Accept all authenticators

  # WebAuthn Passwordless Policy (future enhancement)
  webAuthnPolicyPasswordlessRpEntityName: "Webank"
  webAuthnPolicyPasswordlessRpId: "${DOMAIN}"
  webAuthnPolicyPasswordlessSignatureAlgorithms: '["ES256","RS256"]'
  webAuthnPolicyPasswordlessAttestationConveyancePreference: "none"
  webAuthnPolicyPasswordlessAuthenticatorAttachment: "cross-platform,platform"
  webAuthnPolicyPasswordlessRequireResidentKey: "No"
  webAuthnPolicyPasswordlessUserVerificationRequirement: "required"
  webAuthnPolicyPasswordlessCreateTimeout: 60
  webAuthnPolicyPasswordlessAvoidSameAuthenticatorRegister: false
  webAuthnPolicyPasswordlessAcceptableAaguids: '[]'

# Service Account Users - Role Assignments
# These service accounts are automatically created by Keycloak when clients have
# serviceAccountsEnabled: true. We define them here to assign realm-management roles.
users:
  # User Sync Service Account
  # Requires manage-users permission to sync users between Fineract and Keycloak
  - username: service-account-${USER_SYNC_SERVICE_CLIENT_ID}
    enabled: true
    serviceAccountClientId: "${USER_SYNC_SERVICE_CLIENT_ID}"
    clientRoles:
      realm-management:
        - manage-users
        - view-users
        - query-users
        - view-realm  # Required for admin.get_realm() health check
    attributes:
      description: ["Service account for user-sync-service - manages user synchronization"]
      managed_by: ["keycloak-config-cli"]

  # Default Users for Development
  # NOTE: These are initial users for dev/uat. Production users should be created via UI/API.
  # Passwords are substituted from keycloak-default-users secret at runtime

  # Admin user - Full administrative access
  - username: admin
    enabled: true
    emailVerified: true
    firstName: System
    lastName: Administrator
    email: admin@fineract.dev
    credentials:
      - type: password
        userLabel: "initial"
        value: "${ADMIN_PASSWORD}"
        temporary: false
    realmRoles:
      - admin
      - staff
    groups:
      - /head-office
    attributes:
      employee_id: ["EMP001"]
      office_id: ["1"]
      department: ["IT"]

  # Mifos user - Admin user with full access to all frontend apps
  - username: mifos
    enabled: true
    emailVerified: true
    firstName: Mifos
    lastName: User
    email: mifos@fineract.dev
    credentials:
      - type: password
        userLabel: "initial"
        value: "${MIFOS_PASSWORD}"
        temporary: false
    realmRoles:
      - Admin
      - Super User
      - Accountant
    groups:
      - /head-office
    attributes:
      employee_id: ["EMP002"]
      office_id: ["1"]
      department: ["Lending"]

#   # ============================================================================
#   # Service Account Users - Role Assignments
#   # ============================================================================
#   # Service accounts are automatically created by Keycloak when a client has
#   # serviceAccountsEnabled: true. We define them here to assign realm roles
#   # via keycloak-config-cli, making role assignment GitOps-native and idempotent.
#   #
#   # Naming Convention: service-account-{client-id}
#   # ============================================================================

#   # Fineract Data Loader Service Account
#   # Used by: fineract-config-cli for automated data loading operations
#   # Requires: admin and Super User roles for full CRUD access to Fineract entities
#   - username: service-account-${FINERACT_DATA_LOADER_CLIENT_ID}
#     enabled: true
#     serviceAccountClientId: "${FINERACT_DATA_LOADER_CLIENT_ID}"
#     realmRoles:
#       - admin
#       - Super User
#       - staff
#     attributes:
#       description: ["Service account for fineract-config-cli automated data loading"]
#       managed_by: ["keycloak-config-cli"]
#       purpose: ["Automated Fineract configuration and data loading via fineract-config-cli"]
