---
apiVersion: batch/v1
kind: Job
metadata:
  name: fineract-data-calendar
  namespace: fineract-dev
  annotations:
    argocd.argoproj.io/sync-wave: '40'
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: fineract-data-loader
      initContainers:
      # Validate YAML syntax before loading
      - name: validate-yaml
        image: ghcr.io/adorsys-gis/fineract-loader:deploy-key-ca352f5
        command:
        - python3
        - /app/validate_yaml_data.py
        - /data
        volumeMounts:
        - name: data
          mountPath: /data
          readOnly: true
      containers:
      - name: loader
        image: ghcr.io/adorsys-gis/fineract-loader:deploy-key-ca352f5
        command:
        - python3
        - /app/loaders/load_calendar.py
        args:
        - --yaml-dir
        - /data
        - --fineract-url
        - $(FINERACT_URL)
        - --tenant
        - $(TENANT)
        env:
        - name: FINERACT_URL
          value: https://api.dev.fineract.com
        - name: TENANT
          value: default
        - name: FINERACT_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-id
        - name: FINERACT_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-secret
        - name: FINERACT_TOKEN_URL
          value: "http://keycloak-service.fineract-dev.svc.cluster.local:8080/auth/realms/fineract/protocol/openid-connect/token"
        volumeMounts:
        - name: data
          mountPath: /data
          readOnly: true
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 256Mi
            cpu: 200m
      volumes:
      # ConfigMap mounted directly to /data (flat structure, loaders filter by 'kind')
      - name: data
        configMap:
          name: fineract-data-calendar
