---
apiVersion: batch/v1
kind: Job
metadata:
  name: fineract-data-accounting
  namespace: fineract-dev
  annotations:
    argocd.argoproj.io/sync-wave: '21'
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: fineract-data-loader
      initContainers:
      - name: organize-files
        image: python:3.11-slim
        command:
        - /bin/sh
        - -c
        args:
        - "pip install --quiet --no-cache-dir pyyaml && python3 <<'EOF'\nimport os\nimport yaml\nfrom pathlib import Path\n\n# Mapping of YAML kind to target subdirectory\nKIND_TO_DIR = {\n    'ChartOfAccounts': 'accounting/chart-of-accounts',\n    'FinancialActivityMapping': 'accounting/financial-activity-mappings',\n    'FundSource': 'accounting/fund-sources',\n    'LoanProductAccounting': 'accounting/loan-product-accounting',\n    'LoanProvisioning': 'accounting/loan-provisioning',\n    'PaymentType': 'accounting/payment-types',\n    'PaymentTypeAccounting': 'accounting/payment-type-accounting',\n    'SavingsProductAccounting': 'accounting/savings-product-accounting',\n    'TaxGroup': 'accounting/tax-groups',\n}\n\nsource_dir = Path('/configmap-data')\ntarget_dir = Path('/data')\n\n# Process each YAML file\nfor yaml_file in source_dir.glob('*.yaml'):\n    try:\n        with open(yaml_file, 'r') as f:\n            doc = yaml.safe_load(f)\n\n        kind = doc.get('kind')\n        if kind in KIND_TO_DIR:\n            subdir = target_dir\
          \ / KIND_TO_DIR[kind]\n            subdir.mkdir(parents=True, exist_ok=True)\n\n            # Copy file to subdirectory\n            target_file = subdir / yaml_file.name\n            with open(yaml_file, 'r') as src, open(target_file, 'w') as dst:\n                dst.write(src.read())\n            print(f\"Copied {yaml_file.name} -> {KIND_TO_DIR[kind]}/{yaml_file.name}\")\n        else:\n            print(f\"Warning: Unknown kind '{kind}' in {yaml_file.name}\")\n    except Exception as e:\n        print(f\"Error processing {yaml_file.name}: {e}\")\n\nprint(\"\\nDirectory structure created:\")\nos.system('find /data -type f | sort')\nEOF"
        volumeMounts:
        - name: configmap-data
          mountPath: /configmap-data
          readOnly: true
        - name: data
          mountPath: /data
      - name: validate-yaml
        image: ghcr.io/adorsys-gis/fineract-loader:deploy-key-ca352f5
        command:
        - python3
        - /app/validate_yaml_data.py
        - /data
        volumeMounts:
        - name: data
          mountPath: /data
          readOnly: true
      containers:
      - name: loader
        image: ghcr.io/adorsys-gis/fineract-loader:deploy-key-ca352f5
        command:
        - python3
        - /app/loaders/load_accounting.py
        args:
        - --yaml-dir
        - /data
        - --fineract-url
        - $(FINERACT_URL)
        - --tenant
        - $(TENANT)
        env:
        - name: FINERACT_URL
          value: https://api.dev.fineract.com
        - name: TENANT
          value: default
        - name: FINERACT_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-id
        - name: FINERACT_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-secret
        - name: FINERACT_TOKEN_URL
          value: "http://keycloak-service.fineract-dev.svc.cluster.local:8080/auth/realms/fineract/protocol/openid-connect/token"
        volumeMounts:
        - name: data
          mountPath: /data
          readOnly: true
        resources:
          requests:
            memory: 256Mi
            cpu: 200m
          limits:
            memory: 512Mi
            cpu: 500m
      volumes:
      - name: configmap-data
        configMap:
          name: fineract-data-accounting
      - name: data
        emptyDir: {}
