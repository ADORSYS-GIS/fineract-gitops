---
apiVersion: batch/v1
kind: Job
metadata:
  name: fineract-data-products
  namespace: fineract-dev
  annotations:
    argocd.argoproj.io/sync-wave: '10'
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: fineract-data-loader

      containers:
      - name: loader
        image: ghcr.io/adorsys-gis/fineract-loader:fin-data-refactor-24948a9
        command:
        - python3
        - /app/loaders/load_products.py
        args:
        - --yaml-dir
        - /data
        - --fineract-url
        - $(FINERACT_URL)
        - --tenant
        - $(TENANT)
        env:
        - name: FINERACT_URL
          value: "https://fineract-write-service.fineract-dev.svc.cluster.local:8443/fineract-provider/api/v1"
        - name: FINERACT_VERIFY_SSL
          value: "false"
        - name: TENANT
          value: default
        - name: FINERACT_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-id
        - name: FINERACT_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-client-secrets
              key: fineract-data-loader-client-secret
        - name: FINERACT_TOKEN_URL
          value: "http://keycloak-service.fineract-dev.svc.cluster.local:8080/auth/realms/fineract/protocol/openid-connect/token"
        - name: FINERACT_LOG_FORMAT
          value: "json"
        - name: FINERACT_LOG_LEVEL
          value: "INFO"
        volumeMounts:
        - name: data
          mountPath: /data
          readOnly: true
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
      volumes:
      # ConfigMap mounted directly - new loader supports flat structure with __ separators
      - name: data
        configMap:
          name: fineract-data-products
