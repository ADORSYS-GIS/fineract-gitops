name: Validate Fineract Data

on:
  pull_request:
    paths:
      - 'operations/fineract-data/data/**'
      - 'operations/fineract-data/schemas/**'
      - 'operations/fineract-data/scripts/**'
      - 'operations/fineract-data/kubernetes/**'
  push:
    branches:
      - main
      - develop
    paths:
      - 'operations/fineract-data/**'
  workflow_dispatch:

jobs:
  validate-yaml:
    name: Validate YAML Data
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pyyaml requests jsonschema
        working-directory: operations/fineract-data

      - name: Validate YAML syntax
        run: |
          python3 scripts/validate_yaml_data.py data/dev/ --verbose
        working-directory: operations/fineract-data

      - name: Check for YAML syntax errors
        run: |
          find data/dev -name "*.yaml" -type f | while read file; do
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
        working-directory: operations/fineract-data

  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install jsonschema

      - name: Validate schema syntax
        run: |
          find schemas -name "*.schema.json" -type f | while read schema; do
            python3 -c "import json; json.load(open('$schema'))" || exit 1
          done
        working-directory: operations/fineract-data

      - name: Count schemas
        run: |
          schema_count=$(find schemas -name "*.schema.json" -type f | wc -l)
          echo "Found $schema_count JSON schemas"
          if [ "$schema_count" -lt 30 ]; then
            echo "ERROR: Expected at least 30 schemas, found $schema_count"
            exit 1
          fi
        working-directory: operations/fineract-data

  validate-kubernetes:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.0.0'

      - name: Validate kustomization
        run: |
          kustomize build kubernetes/ > /dev/null
        working-directory: operations/fineract-data

      - name: Check job count
        run: |
          job_count=$(find kubernetes/jobs -name "*.yaml" -type f | wc -l)
          echo "Found $job_count Kubernetes jobs"
          if [ "$job_count" -lt 39 ]; then
            echo "ERROR: Expected at least 39 jobs, found $job_count"
            exit 1
          fi
        working-directory: operations/fineract-data

      - name: Validate job manifests
        run: |
          find kubernetes/jobs -name "*.yaml" -type f | while read job; do
            # Check for required fields
            grep -q "apiVersion:" "$job" || { echo "Missing apiVersion in $job"; exit 1; }
            grep -q "kind: Job" "$job" || { echo "Missing kind: Job in $job"; exit 1; }
            grep -q "argocd.argoproj.io/sync-wave" "$job" || { echo "Missing sync-wave in $job"; exit 1; }
          done
        working-directory: operations/fineract-data

  lint-python:
    name: Lint Python Loaders
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pylint flake8

      - name: Check Python syntax
        run: |
          find scripts/loaders -name "*.py" -type f | while read script; do
            python3 -m py_compile "$script" || exit 1
          done
        working-directory: operations/fineract-data

      - name: Count loaders
        run: |
          loader_count=$(find scripts/loaders -name "*.py" -type f ! -name "base_loader.py" | wc -l)
          echo "Found $loader_count Python loaders"
          if [ "$loader_count" -lt 50 ]; then
            echo "WARNING: Expected at least 50 loaders, found $loader_count"
          fi
        working-directory: operations/fineract-data

  validate-structure:
    name: Validate Directory Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required directories
        run: |
          required_dirs=(
            "data/dev"
            "kubernetes/jobs"
            "schemas"
            "scripts/loaders"
            "docs"
          )

          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "ERROR: Missing required directory: $dir"
              exit 1
            fi
          done
        working-directory: operations/fineract-data

      - name: Check required files
        run: |
          required_files=(
            "README.md"
            "docker-compose.yml"
            "kubernetes/kustomization.yaml"
            "kubernetes/rbac.yaml"
            "scripts/loaders/base_loader.py"
            "scripts/test_all_loaders.sh"
            "scripts/validate_yaml_data.py"
            "docs/LOCAL_TESTING.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing required file: $file"
              exit 1
            fi
          done
        working-directory: operations/fineract-data

      - name: Check for temporary files
        run: |
          temp_files=$(find . -name "*COMPLETE*.md" -o -name "*STATUS*.md" -o -name "*REMAINING*.md" 2>/dev/null | grep -v node_modules || true)
          if [ -n "$temp_files" ]; then
            echo "WARNING: Found temporary documentation files:"
            echo "$temp_files"
          fi
        working-directory: operations/fineract-data

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-schemas, validate-kubernetes, lint-python, validate-structure]

    steps:
      - name: Summary
        run: |
          echo "âœ… All validation checks passed!"
          echo ""
          echo "Validated:"
          echo "  - YAML data files"
          echo "  - JSON schemas"
          echo "  - Kubernetes manifests"
          echo "  - Python loaders"
          echo "  - Directory structure"
