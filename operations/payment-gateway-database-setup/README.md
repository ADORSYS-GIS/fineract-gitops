# Payment Gateway Database Setup

This directory contains Kubernetes Jobs for setting up the Payment Gateway database.

## Overview

The `create-payment-gateway-db-job.yaml` (in `base/`) creates the Payment Gateway database and user in RDS PostgreSQL. This job is designed to be run once during initial setup or when deploying the Payment Gateway service.

## Prerequisites

Before running this job:

1.  **RDS Instance**: PostgreSQL RDS instance must be running.
2.  **Secrets Created**: Sealed Secrets must have been created and unsealed:
    *   `fineract-db-credentials`: Contains admin credentials (has CREATEDB privileges).
    *   `payment-gateway-db-credentials`: Contains the password for the new `payment_gateway` user. This secret is generated by the `scripts/seal-payment-gateway-secrets.sh` script.
3.  **Network Access**: Kubernetes cluster must have network access to RDS.

## Setup Instructions

### 1. Generate Sealed Secret

Use the provided script to generate the sealed secret for the Payment Gateway database credentials. This script fetches the RDS password from Terraform state and encrypts it using `kubeseal`.

```bash
# Ensure you have AWS credentials configured (aws configure)
./scripts/seal-payment-gateway-secrets.sh dev
# Replace 'dev' with 'uat' or 'production' as needed
```

This will create `secrets/<env>/payment-gateway-db-credentials-sealed.yaml`.

### 2. Apply the Secret

Apply the generated sealed secret to your cluster (if not using ArgoCD):

```bash
kubectl apply -f secrets/dev/payment-gateway-db-credentials-sealed.yaml
```

### 3. Run the Database Setup Job

Apply the job to create the database and user:

```bash
kubectl apply -k operations/payment-gateway-database-setup/base/
```

Or if you are deploying via ArgoCD, this job is included in the Sync process.

## Job Details

The job performs the following:

1.  Connects to RDS using `fineract-db-credentials` (admin).
2.  Checks if `payment_gateway` database exists.
3.  Creates `payment_gateway` database if it doesn't exist.
4.  Creates `payment_gateway` user with the password from `payment-gateway-db-credentials`.
5.  Grants privileges to the user on the database.

## Troubleshooting

*   **Job fails with authentication error**: Ensure `fineract-db-credentials` are correct and the RDS instance is accessible.
*   **Job fails with "password authentication failed for user payment_gateway"**: This might happen *after* the job if the application cannot connect. Ensure the `payment-gateway-db-credentials` secret matches what was used to create the user. If they are out of sync, you may need to update the user's password in the database manually or re-run the setup with the correct secret.

## Cleanup

The job is configured with `ttlSecondsAfterFinished: 3600`, so it will be automatically cleaned up 1 hour after completion.
