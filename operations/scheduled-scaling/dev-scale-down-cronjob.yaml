apiVersion: batch/v1
kind: CronJob
metadata:
  name: dev-scale-down
  namespace: argocd
  labels:
    environment: dev
    workload: "scheduled-scaling"
    cost-optimization: "enabled"
spec:
  concurrencyPolicy: Forbid
  schedule: "0 19 * * 1-5"  # 7 PM UTC, weekdays
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        spec:
          serviceAccountName: fineract-scaler
          restartPolicy: OnFailure
          containers:
          - name: scale-down
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "Scaling down dev cluster to 1 node..."
              aws eks update-nodegroup-config \
                --cluster-name apache-fineract-dev \
                --nodegroup-name apache-fineract-dev-node-group \
                --scaling-config '{"minSize":1,"desiredSize":1}'
            env:
            - name: AWS_DEFAULT_REGION
              value: "eu-central-1"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: fineract-scaler-aws-credentials
                  key: aws-access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: fineract-scaler-aws-credentials
                  key: aws-secret-access-key
          resources:
            requests:
              cpu: "100m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "128Mi"
