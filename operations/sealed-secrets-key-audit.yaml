# Sealed Secrets Key Rotation Audit Log
#
# Purpose: Track all sealed secrets key operations for compliance and operational awareness
# - Key rotations (planned and unplanned)
# - Disaster recovery events
# - Key generation and backup operations
#
# Maintenance:
# - Update this file after EVERY key operation
# - Commit to Git for historical tracking
# - Review quarterly for compliance audits
#
# Format:
# - YAML for structure and readability
# - Chronological order (newest first)
# - Include all required metadata

---
apiVersion: fineract.gitops/v1
kind: KeyRotationAudit
metadata:
  name: sealed-secrets-key-audit
  description: Audit log for Sealed Secrets controller key operations
  created: 2025-01-19
  lastUpdated: 2025-01-19

# Rotation Policy
rotationPolicy:
  # How often keys should be rotated
  schedule: "Every 90 days"

  # Next planned rotation dates
  nextRotationDates:
    development: "2025-04-19"  # 90 days from 2025-01-19
    uat: "2025-04-19"
    production: "2025-04-19"

  # Who is responsible for executing rotations
  responsibleTeam: "DevOps Team"

  # Notification channels for rotation reminders
  notifications:
    - type: slack
      channel: "#devops-alerts"
    - type: email
      recipients: ["devops@example.com"]

# Key Metadata (current state)
currentKeys:
  development:
    keyId: "initial-key-2025-01-19"
    generatedDate: "2025-01-19T00:00:00Z"
    algorithm: "RSA-2048"
    status: "active"
    backupLocation: "AWS Secrets Manager: /fineract/dev/sealed-secrets/master-key"
    lastBackupDate: "2025-01-19T00:00:00Z"
    sealedSecretsCount: 8
    notes: "Initial deployment of sealed secrets"

  uat:
    keyId: "initial-key-2025-01-19"
    generatedDate: "2025-01-19T00:00:00Z"
    algorithm: "RSA-2048"
    status: "active"
    backupLocation: "AWS Secrets Manager: /fineract/uat/sealed-secrets/master-key"
    lastBackupDate: "2025-01-19T00:00:00Z"
    sealedSecretsCount: 8
    notes: "Initial deployment of sealed secrets"

  production:
    keyId: "initial-key-2025-01-19"
    generatedDate: "2025-01-19T00:00:00Z"
    algorithm: "RSA-2048"
    status: "active"
    backupLocation: "AWS Secrets Manager: /fineract/production/sealed-secrets/master-key"
    lastBackupDate: "2025-01-19T00:00:00Z"
    sealedSecretsCount: 8
    notes: "Initial deployment of sealed secrets"

# Audit History (chronological, newest first)
auditHistory:
  # ========================================
  # TEMPLATE FOR NEW ENTRIES
  # ========================================
  # Copy this template for each new entry:
  #
  # - date: "YYYY-MM-DDTHH:MM:SSZ"
  #   environment: "development | uat | production"
  #   operation: "rotation | backup | restore | generation | migration"
  #   operationType: "planned | unplanned | emergency"
  #   performedBy: "Name or automated system"
  #   keyId: "Unique identifier for the key"
  #   algorithm: "RSA-2048"
  #   reason: "Why this operation was performed"
  #   procedure: "Which procedure/runbook was followed"
  #   duration: "Time taken (minutes)"
  #   downtime: "yes | no"
  #   downtimeMinutes: 0
  #   backupCreated: "yes | no"
  #   backupLocation: "AWS Secrets Manager path or N/A"
  #   sealedSecretsRegenerated: 0
  #   sealedSecretsList:
  #     - secret-name-1
  #     - secret-name-2
  #   verification:
  #     - "validate-sealed-secrets-compatibility.sh passed"
  #     - "All pods running successfully"
  #   issues: []
  #   postMortem: "Link to incident report or N/A"
  #   notes: "Additional context"
  #
  # ========================================
  # ACTUAL AUDIT ENTRIES START HERE
  # ========================================

  # Example: Initial deployment
  - date: "2025-01-19T00:00:00Z"
    environment: "all"
    operation: "generation"
    operationType: "planned"
    performedBy: "DevOps Team (Migration)"
    keyId: "initial-key-2025-01-19"
    algorithm: "RSA-2048"
    reason: "Initial deployment of Sealed Secrets controller"
    procedure: "docs/SEALED_SECRETS_DEPLOYMENT_GUIDE.md"
    duration: 60
    downtime: "no"
    downtimeMinutes: 0
    backupCreated: "yes"
    backupLocation: "AWS Secrets Manager: /fineract/{env}/sealed-secrets/master-key"
    sealedSecretsRegenerated: 8
    sealedSecretsList:
      - fineract-db-credentials
      - keycloak-db-credentials
      - keycloak-admin-credentials
      - fineract-admin-credentials
      - keycloak-client-secrets
      - oauth2-proxy-secrets
      - fineract-redis-secret
      - grafana-admin-credentials
    verification:
      - "validate-sealed-secrets-compatibility.sh passed"
      - "All applications deployed successfully"
      - "Fineract API responding"
      - "Keycloak authentication working"
    issues: []
    postMortem: "N/A"
    notes: "Migration from External Secrets Operator to Sealed Secrets completed successfully"

  # ========================================
  # ADD NEW ENTRIES BELOW (NEWEST FIRST)
  # ========================================

  # Example entry for future rotation (DELETE THIS BEFORE REAL USE):
  # - date: "2025-04-19T02:00:00Z"
  #   environment: "development"
  #   operation: "rotation"
  #   operationType: "planned"
  #   performedBy: "John Doe"
  #   keyId: "rotation-2025-04-19-dev"
  #   algorithm: "RSA-2048"
  #   reason: "90-day scheduled key rotation"
  #   procedure: "docs/SEALED_SECRETS_DR_RUNBOOK.md Section 4"
  #   duration: 35
  #   downtime: "no"
  #   downtimeMinutes: 0
  #   backupCreated: "yes"
  #   backupLocation: "AWS Secrets Manager: /fineract/dev/sealed-secrets/master-key (version 2)"
  #   sealedSecretsRegenerated: 8
  #   sealedSecretsList:
  #     - fineract-db-credentials
  #     - keycloak-db-credentials
  #     - keycloak-admin-credentials
  #     - fineract-admin-credentials
  #     - keycloak-client-secrets
  #     - oauth2-proxy-secrets
  #     - fineract-redis-secret
  #     - grafana-admin-credentials
  #   verification:
  #     - "validate-sealed-secrets-compatibility.sh passed"
  #     - "All pods restarted successfully"
  #     - "No decryption errors in controller logs"
  #   issues: []
  #   postMortem: "N/A"
  #   notes: "Routine rotation completed without issues"

  # Example entry for disaster recovery (DELETE THIS BEFORE REAL USE):
  # - date: "2025-02-15T14:30:00Z"
  #   environment: "production"
  #   operation: "restore"
  #   operationType: "emergency"
  #   performedBy: "Jane Smith (On-call)"
  #   keyId: "initial-key-2025-01-19"
  #   algorithm: "RSA-2048"
  #   reason: "Controller pod deleted accidentally, keys lost"
  #   procedure: "docs/SEALED_SECRETS_DR_RUNBOOK.md Section 2"
  #   duration: 12
  #   downtime: "yes"
  #   downtimeMinutes: 8
  #   backupCreated: "no"
  #   backupLocation: "Restored from AWS Secrets Manager: /fineract/production/sealed-secrets/master-key"
  #   sealedSecretsRegenerated: 0
  #   sealedSecretsList: []
  #   verification:
  #     - "validate-sealed-secrets-compatibility.sh passed"
  #     - "All secrets decrypted successfully"
  #     - "Fineract API responding normally"
  #   issues:
  #     - issue: "Controller pod was deleted by mistake during troubleshooting"
  #       resolution: "Keys restored from backup, no data loss"
  #   postMortem: "https://example.com/incidents/2025-02-15-sealed-secrets"
  #   notes: "Incident caused by accidental kubectl delete. Recovery completed within RTO. Added safeguards to prevent future occurrences."

# Compliance and Reporting
compliance:
  # Regulatory requirements
  requirements:
    - name: "Key Rotation Frequency"
      requirement: "Keys must be rotated every 90 days"
      status: "compliant"
      lastCheck: "2025-01-19"

    - name: "Backup Verification"
      requirement: "Backups must be tested monthly"
      status: "compliant"
      lastCheck: "2025-01-19"
      automation: ".github/workflows/test-sealed-secrets-backup.yaml"

    - name: "Audit Trail"
      requirement: "All key operations must be logged"
      status: "compliant"
      lastCheck: "2025-01-19"
      location: "operations/sealed-secrets-key-audit.yaml (this file)"

    - name: "Disaster Recovery Testing"
      requirement: "DR procedures must be tested quarterly"
      status: "compliant"
      lastCheck: "2025-01-19"
      nextTest: "2025-04-19"

  # Quarterly audit report generation
  reports:
    - quarter: "Q1 2025"
      startDate: "2025-01-01"
      endDate: "2025-03-31"
      status: "in-progress"
      generatedBy: null
      location: null
      findings: []

# Statistics (auto-calculated from auditHistory)
statistics:
  totalOperations: 1
  operationsByType:
    generation: 1
    rotation: 0
    backup: 0
    restore: 0
    migration: 0

  operationsByEnvironment:
    development: 1
    uat: 1
    production: 1

  averageRotationDuration: "35 minutes (estimated)"
  averageRestoreDuration: "12 minutes (estimated)"

  downtimeEvents: 0
  totalDowntimeMinutes: 0

  lastRotationDates:
    development: "2025-01-19 (initial)"
    uat: "2025-01-19 (initial)"
    production: "2025-01-19 (initial)"

  daysUntilNextRotation:
    development: 90
    uat: 90
    production: 90

# Related Documentation
relatedDocumentation:
  - name: "Sealed Secrets DR Runbook"
    path: "docs/SEALED_SECRETS_DR_RUNBOOK.md"
    description: "Quick-reference emergency runbook"

  - name: "Disaster Recovery Guide"
    path: "docs/DISASTER_RECOVERY.md"
    description: "Comprehensive DR procedures"

  - name: "Sealed Secrets Deployment Guide"
    path: "docs/SEALED_SECRETS_DEPLOYMENT_GUIDE.md"
    description: "Initial deployment instructions"

  - name: "Secrets Management"
    path: "docs/SECRETS_MANAGEMENT.md"
    description: "Complete secrets strategy"

  - name: "ADR-003: Sealed Secrets"
    path: "docs/architecture/ADR-003-sealed-secrets.md"
    description: "Architectural decision record"

  - name: "Backup Script"
    path: "scripts/backup-sealed-secrets-keys.sh"
    description: "Automated backup to AWS"

  - name: "Restore Script"
    path: "scripts/restore-sealed-secrets-keys.sh"
    description: "Automated restore from AWS"

  - name: "Validation Script"
    path: "scripts/validate-sealed-secrets-compatibility.sh"
    description: "Test key compatibility"

  - name: "Regeneration Script"
    path: "scripts/regenerate-sealed-secrets.sh"
    description: "Re-seal all secrets after rotation"

# Maintenance Notes
maintenanceNotes:
  - date: "2025-01-19"
    note: "Initial audit log created during sealed secrets migration"
    author: "DevOps Team"

  # Add maintenance notes when updating this file:
  # - date: "YYYY-MM-DD"
  #   note: "Description of changes to this audit log"
  #   author: "Your Name"

# Instructions for Updating This File
instructions: |
  ## How to Update This Audit Log

  ### After Key Rotation:
  1. Copy the audit entry template from line 50
  2. Fill in ALL fields with accurate information
  3. Add entry to auditHistory (newest first)
  4. Update currentKeys section with new key metadata
  5. Update nextRotationDates (add 90 days)
  6. Update statistics section
  7. Commit to Git: `git commit -m "audit: record key rotation for {env}"`

  ### After Disaster Recovery:
  1. Follow same process as key rotation
  2. Set operationType: "emergency"
  3. Set operation: "restore"
  4. Document issues encountered
  5. Link to post-mortem document
  6. Commit immediately after incident resolution

  ### Monthly Review:
  1. Verify all operations from previous month are logged
  2. Check compliance status
  3. Update statistics if needed
  4. Generate quarterly report (if quarter ended)

  ### Quarterly Report:
  1. Export auditHistory for the quarter
  2. Generate compliance report
  3. Calculate statistics
  4. Present to management/security team
  5. Store report in docs/compliance/

  ## Automation
  - Backup validation runs monthly via GitHub Actions
  - Rotation reminders can be configured in calendar/alerting system
  - Consider adding automation to update this file automatically

  ## Git Workflow
  - Always commit changes to this file separately (not mixed with code changes)
  - Use descriptive commit messages: "audit: record {operation} for {env}"
  - Tag compliance report commits: `git tag compliance-Q1-2025`

---
# END OF AUDIT LOG
