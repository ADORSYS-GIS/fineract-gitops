# ============================================
# Development Environment - K3s Standalone Mode
# ============================================
#
# PURPOSE: Complete K3s-based Kubernetes environment with ALL infrastructure
#
# USE CASE:
# - You want a complete, self-contained dev environment
# - You don't have an existing EKS cluster
# - You want full control over the Kubernetes cluster
# - Cost optimization is important (K3s is cheaper than EKS)
#
# WHAT TERRAFORM CREATES:
# - VPC with public/private subnets (2 AZs)
# - K3s cluster: 2x t3.xlarge EC2 instances (1 server + 1 agent)
# - RDS PostgreSQL db.t4g.micro
# - S3 buckets (documents, backups, artifacts)
# - IAM roles and policies
# - Security groups
# - SES email configuration
#
# COST BREAKDOWN:
# - K3s instances (2x t3.xlarge): ~$240/month (4 vCPU, 16GB RAM each)
# - RDS db.t4g.micro: ~$12/month (PostgreSQL with Fineract + Keycloak schemas)
# - NAT Gateway: DISABLED to save $32/month (K3s in public subnets)
# - S3 + data transfer: ~$5-8/month
# - EBS volumes: ~$3-5/month
# - AWS Secrets Manager: ~$2/month
# Total: ~$380-385/month
#
# COMPARISON:
# - K3s (this config): ~$380/month
# - EKS equivalent: ~$500/month (includes $72/month control plane)
# - Savings: ~$120/month (24% cheaper than EKS)
#
# FOR EKS ADD-ON MODE: Use dev.tfvars instead
# ============================================

# Development Environment - K3s (Cost-Optimized)
# Proven reliable configuration with t3.xlarge instances

# Basic Configuration
cluster_name = "fineract-dev"
environment  = "dev"
aws_region   = "us-east-2"

# Deployment Type (k3s for cost optimization)
deployment_type = "k3s"

# VPC Configuration (automatically created)
vpc_cidr           = "10.0.0.0/16"
az_count           = 2     # 2 AZs for HA
enable_nat_gateway = false # DISABLED to save $32/month - K3s in public subnets
enable_flow_logs   = false # Disable to save costs

# K3s Configuration (Updated to t3.xlarge for increased capacity, 4 vCPU, 16GB RAM, 2 nodes total)
k3s_instance_type = "t3.xlarge" # x86/amd64, 4 vCPU, 16GB RAM (~$120/month per instance) - upgraded for keycloak-config and fineract-data operations
k3s_version           = "v1.28.5+k3s1"
k3s_high_availability = false          # Single server node for dev
k3s_agent_count       = 1              # 1 worker node (total 2 nodes: 1 server + 1 agent)
k3s_ssh_key_name      = "fineract-k3s" # SSH key for instance access

# Security (WARNING: Open to world for dev convenience)
# In production, restrict these to your IP or VPN CIDR
k3s_api_access_cidrs = ["0.0.0.0/0"] # Allow kubectl access from anywhere
k3s_ssh_access_cidrs = ["0.0.0.0/0"] # Allow SSH from anywhere

# Kubernetes
kubernetes_namespace = "fineract-dev"

# RDS Configuration - Cost Optimized
rds_postgres_version      = "15.14"
rds_instance_class        = "db.t4g.micro" # Smallest ARM instance (~$12/month)
rds_allocated_storage     = 20             # 20GB minimum
rds_max_allocated_storage = 50             # Allow growth to 50GB
rds_storage_type          = "gp3"          # General purpose SSD

rds_database_name   = "fineract"
rds_master_username = "fineract"
rds_max_connections = "100"

# Single-AZ for dev (no HA needed, saves money)
rds_multi_az                = false
rds_backup_retention_period = 3 # Minimum backups (3 days)

# Monitoring
rds_performance_insights_enabled = true # Free for t4g instances!
rds_monitoring_interval          = 60   # Basic monitoring

# Deletion protection OFF for dev (easier to destroy)
rds_deletion_protection = false

# ElastiCache Configuration - REMOVED
# Using in-cluster fineract-redis instead (saves $11/month)
# Redis now deployed as Kubernetes StatefulSet for dual use:
# - OAuth2 Proxy session storage
# - Fineract caching
redis_version            = "7.0"
redis_node_type          = "cache.t4g.micro"
redis_num_cache_clusters = 0 # DISABLED - using in-cluster Redis

# Encryption
redis_encryption_at_rest    = false # N/A - using in-cluster Redis
redis_encryption_in_transit = false # N/A - using in-cluster Redis
redis_auth_token_enabled    = false # N/A - using in-cluster Redis

redis_snapshot_retention_limit = 0 # DISABLED

# S3 Configuration
s3_enable_versioning           = true # Enable versioning for safety
s3_documents_lifecycle_enabled = true # Auto-cleanup old versions
s3_backups_expiration_days     = 90   # Keep backups for 90 days

# Expensive features disabled for dev
s3_enable_transfer_acceleration = false # Saves ~$5/month
s3_enable_intelligent_tiering   = false # Saves ~$2/month

# KMS (optional - use AWS managed keys to save $1/month)
# kms_key_id = null  # Default: AWS managed keys

# AWS SES (Simple Email Service) Configuration
# Email addresses must be verified in AWS SES before sending emails
ses_enabled = true
ses_verified_emails = [
  "guymoyo@gmail.com"
]
ses_sender_email = "guymoyo@gmail.com"
ses_sender_name  = "Fineract Platform"

# Advanced SES options (optional)
# ses_domain = null  # Set to your domain for production (e.g., "example.com")
# ses_allowed_sender_patterns = ["*"]  # Allow any sender pattern
# ses_enable_cross_account_sending = false
# ses_authorized_sender_arns = []

# Tags
tags = {
  CostCenter     = "engineering"
  Team           = "platform"
  Purpose        = "development"
  CostModel      = "optimized"
  AutoShutdown   = "enabled" # Can be used with Lambda for after-hours shutdown
  DeploymentType = "k3s"
}

# ============================================
# COST OPTIMIZATION TIPS
# ============================================
#
# 1. Auto-Shutdown (Save ~50%):
#    Stop instances after work hours:
#    - Stop K3s instances: aws ec2 stop-instances --instance-ids <id>
#    - Stop RDS: aws rds stop-db-instance --db-instance-identifier <id>
#    - Total cost with 8hrs/day: ~$25-30/month
#
# 2. Spot Instances (Save ~70% on compute):
#    Use spot instances for K3s agents (not implemented in this module)
#    - Could reduce compute costs to ~$4/month
#
# 3. Reserved Instances (Save ~30-40%):
#    Commit to 1-year for production:
#    - RDS Reserved: $8/month (instead of $12)
#    - ElastiCache Reserved: $7/month (instead of $11)
#
# 4. Remove NAT Gateway (Save $32/month):
#    If RDS/ElastiCache don't need internet:
#    - Set enable_nat_gateway = false
#    - Use VPC endpoints for AWS services
#    - Total cost: ~$25-30/month
#
# 5. Use smaller instances (if sufficient):
#    - K3s: t4g.micro (1 vCPU) instead of t4g.small
#    - Saves $6/month but may be too small
#
# ============================================
# COMPARISON: K3s vs EKS (Development)
# ============================================
#
# This setup (K3s):      ~$50-60/month
# EKS equivalent:         ~$150-160/month
# Savings:                ~$100/month (67% cheaper!)
#
# What you're NOT paying for with K3s:
# - EKS control plane:    $72/month
# - Larger EC2 instances: $36/month (t4g.medium vs t4g.small)
#
# What's the same:
# - RDS, ElastiCache, S3 costs are identical
# - Same Fineract functionality
# - 100% Kubernetes compatible
#
# ============================================
# NEXT STEPS
# ============================================
#
# 1. Review and customize this file for your needs
# 2. Run: terraform init
# 3. Run: terraform plan -var-file=environments/dev-k3s.tfvars
# 4. Run: terraform apply -var-file=environments/dev-k3s.tfvars
# 5. Wait 8-10 minutes for infrastructure to be ready
# 6. Get kubeconfig: terraform output -raw kubeconfig > ~/.kube/config-fineract-dev
# 7. Deploy Fineract: kubectl apply -k ../../environments/dev-aws
#

# GitHub Token for ArgoCD (set via environment variable TF_VAR_github_token)
# Or uncomment and set directly (NOT recommended for production):
# github_token = "gho_..."
