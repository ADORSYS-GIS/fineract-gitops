# Observability Architecture

This document describes the architecture of the Fineract platform observability stack.

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FINERACT PLATFORM                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  Fineract   │  │  Keycloak   │  │   Redis     │  │  Frontend   │            │
│  │  (Spring)   │  │  (Quarkus)  │  │  (Cache)    │  │   Apps      │            │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
│         │                │                │                │                    │
│         │ Metrics        │ Metrics        │ Metrics        │ (Optional)        │
│         │ Traces         │ Traces         │                │                    │
│         │ Logs           │ Logs           │ Logs           │ Logs              │
└─────────┼────────────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │                │
          ▼                ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           OBSERVABILITY STACK                                    │
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         METRICS (monitoring namespace)                     │  │
│  │  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐    │  │
│  │  │    Prometheus    │    │   AlertManager   │    │     Grafana      │    │  │
│  │  │  ┌────────────┐  │    │  ┌────────────┐  │    │  ┌────────────┐  │    │  │
│  │  │  │  Scraper   │  │───▶│  │  Routing   │  │───▶│  │ Dashboards │  │    │  │
│  │  │  └────────────┘  │    │  └────────────┘  │    │  └────────────┘  │    │  │
│  │  │  ┌────────────┐  │    │         │        │    │  ┌────────────┐  │    │  │
│  │  │  │   TSDB     │  │    │         ▼        │    │  │  Alerting  │  │    │  │
│  │  │  │  (50GB)    │  │    │  ┌────────────┐  │    │  └────────────┘  │    │  │
│  │  │  └────────────┘  │    │  │   Slack    │  │    │                  │    │  │
│  │  │  ┌────────────┐  │    │  │   Email    │  │    │                  │    │  │
│  │  │  │   Rules    │  │    │  └────────────┘  │    │                  │    │  │
│  │  │  └────────────┘  │    │                  │    │                  │    │  │
│  │  └──────────────────┘    └──────────────────┘    └──────────────────┘    │  │
│  │          ▲                                               ▲               │  │
│  │          │ ServiceMonitor / PodMonitor                   │               │  │
│  │          │                                               │               │  │
│  └──────────┼───────────────────────────────────────────────┼───────────────┘  │
│             │                                               │                   │
│  ┌──────────┼───────────────────────────────────────────────┼───────────────┐  │
│  │          │          LOGGING (logging namespace)          │               │  │
│  │  ┌───────┴──────────┐                    ┌───────────────┴───────────┐   │  │
│  │  │    Promtail      │                    │          Loki             │   │  │
│  │  │   (DaemonSet)    │                    │  ┌─────────────────────┐  │   │  │
│  │  │  ┌────────────┐  │                    │  │   Index (BoltDB)    │  │   │  │
│  │  │  │ Log Reader │  │───────────────────▶│  └─────────────────────┘  │   │  │
│  │  │  └────────────┘  │                    │  ┌─────────────────────┐  │   │  │
│  │  │  ┌────────────┐  │                    │  │   Chunks (100GB)    │  │   │  │
│  │  │  │ K8s Labels │  │                    │  └─────────────────────┘  │   │  │
│  │  │  └────────────┘  │                    │                           │   │  │
│  │  └──────────────────┘                    └───────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         TRACING (tracing namespace)                       │  │
│  │  ┌──────────────────────────┐    ┌──────────────────────────────────┐   │  │
│  │  │  OpenTelemetry Collector │    │            Jaeger                 │   │  │
│  │  │  ┌────────────────────┐  │    │  ┌────────────────────────────┐  │   │  │
│  │  │  │ OTLP Receiver      │  │───▶│  │       Collector            │  │   │  │
│  │  │  │ (gRPC/HTTP)        │  │    │  └────────────────────────────┘  │   │  │
│  │  │  └────────────────────┘  │    │  ┌────────────────────────────┐  │   │  │
│  │  │  ┌────────────────────┐  │    │  │   Query (UI) :16686        │  │   │  │
│  │  │  │ Batch Processor    │  │    │  └────────────────────────────┘  │   │  │
│  │  │  └────────────────────┘  │    │  ┌────────────────────────────┐  │   │  │
│  │  │  ┌────────────────────┐  │    │  │   Storage (in-memory)      │  │   │  │
│  │  │  │ Filter Processor   │  │    │  └────────────────────────────┘  │   │  │
│  │  │  └────────────────────┘  │    │                                  │   │  │
│  │  └──────────────────────────┘    └──────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Component Details

### Prometheus Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Prometheus                                │
│                                                                  │
│  ┌────────────────────┐    ┌────────────────────────────────┐  │
│  │  Service Discovery │    │         TSDB                    │  │
│  │  ┌──────────────┐  │    │  ┌────────────────────────┐    │  │
│  │  │ ServiceMonitor│  │    │  │  Head Block (2h)       │    │  │
│  │  │ PodMonitor   │  │    │  │  - in-memory samples   │    │  │
│  │  │ Kubernetes   │  │    │  └────────────────────────┘    │  │
│  │  └──────────────┘  │    │  ┌────────────────────────┐    │  │
│  └─────────┬──────────┘    │  │  Persisted Blocks      │    │  │
│            │               │  │  - 2h compacted chunks │    │  │
│            ▼               │  │  - 50GB retention      │    │  │
│  ┌────────────────────┐    │  └────────────────────────┘    │  │
│  │    Scraper         │    └────────────────────────────────┘  │
│  │  - 30s interval    │                                        │
│  │  - /metrics paths  │─────────────────────────────────────┐  │
│  └────────────────────┘                                     │  │
│                                                             │  │
│  ┌────────────────────┐    ┌────────────────────────────┐  │  │
│  │   Rule Evaluator   │    │     Query Engine           │◀─┘  │
│  │  - Alert rules     │    │  - PromQL                  │     │
│  │  - Recording rules │    │  - Grafana queries         │     │
│  └─────────┬──────────┘    └────────────────────────────┘     │
│            │                                                   │
│            ▼                                                   │
│  ┌────────────────────┐                                       │
│  │   Alert Manager    │                                       │
│  └────────────────────┘                                       │
└─────────────────────────────────────────────────────────────────┘
```

### Metrics Collection Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       Metrics Collection                             │
│                                                                      │
│  Application Pods                                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │    Fineract     │  │    Keycloak     │  │     Redis       │     │
│  │ :8080/actuator  │  │  :8080/metrics  │  │ :9121/metrics   │     │
│  │   /prometheus   │  │                 │  │ (exporter)      │     │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘     │
│           │                    │                    │               │
│           │                    │                    │               │
│           ▼                    ▼                    ▼               │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    ServiceMonitor / PodMonitor                │  │
│  │   ┌────────────────────────────────────────────────────┐     │  │
│  │   │  selector:                                          │     │  │
│  │   │    matchLabels:                                     │     │  │
│  │   │      app: fineract                                  │     │  │
│  │   │  endpoints:                                         │     │  │
│  │   │    - port: http                                     │     │  │
│  │   │      path: /actuator/prometheus                     │     │  │
│  │   └────────────────────────────────────────────────────┘     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                       Prometheus                              │  │
│  │   - Discovers targets via ServiceMonitor                      │  │
│  │   - Scrapes metrics every 30s                                 │  │
│  │   - Stores in TSDB                                           │  │
│  │   - Evaluates alert rules                                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Logging Collection Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       Log Collection                                 │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Kubernetes Node                          │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │  /var/log/pods/                                      │    │   │
│  │  │  ├── fineract-dev_fineract-xxx/                      │    │   │
│  │  │  │   └── fineract/0.log                              │    │   │
│  │  │  ├── fineract-dev_keycloak-xxx/                      │    │   │
│  │  │  │   └── keycloak/0.log                              │    │   │
│  │  │  └── ...                                             │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  │                           │                                  │   │
│  │                           ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │               Promtail (DaemonSet)                   │    │   │
│  │  │  ┌───────────────┐  ┌───────────────────────────┐   │    │   │
│  │  │  │  File Tailer  │  │  Label Enrichment         │   │    │   │
│  │  │  │  - Watches    │  │  - namespace              │   │    │   │
│  │  │  │    log files  │  │  - pod                    │   │    │   │
│  │  │  └───────────────┘  │  - container              │   │    │   │
│  │  │                     │  - app (from labels)      │   │    │   │
│  │  │                     └───────────────────────────┘   │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              │ Push                                  │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                          Loki                                 │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────┐   │   │
│  │  │    Distributor  │─▶│    Ingester     │─▶│   Store    │   │   │
│  │  │  - Validates    │  │  - Builds chunks│  │  - BoltDB  │   │   │
│  │  │  - Distributes  │  │  - WAL          │  │  - Files   │   │   │
│  │  └─────────────────┘  └─────────────────┘  └────────────┘   │   │
│  │                                                              │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │                    Querier                           │    │   │
│  │  │  - LogQL queries                                     │    │   │
│  │  │  - Grafana integration                               │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Tracing Collection Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Distributed Tracing                              │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Request Flow                               │   │
│  │                                                               │   │
│  │   User ──▶ Ingress ──▶ OAuth2 ──▶ Fineract ──▶ PostgreSQL   │   │
│  │              │           │           │                        │   │
│  │              │           │           └──▶ Redis              │   │
│  │              │           │                                    │   │
│  │              │           └──▶ Keycloak                       │   │
│  │              │                                                │   │
│  │  Each service adds spans with:                                │   │
│  │  - Trace ID (shared across all services)                     │   │
│  │  - Span ID (unique per operation)                            │   │
│  │  - Parent Span ID                                            │   │
│  │  - Operation name, duration, status                          │   │
│  │  - Tags (http.method, http.url, error, etc.)                │   │
│  │                                                               │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              │ OTLP (gRPC/HTTP)                     │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │              OpenTelemetry Collector                          │   │
│  │  ┌─────────────────────────────────────────────────────┐     │   │
│  │  │                    Receivers                         │     │   │
│  │  │  - OTLP (gRPC :4317, HTTP :4318)                    │     │   │
│  │  │  - Jaeger (Thrift :14268, gRPC :14250)              │     │   │
│  │  └─────────────────────────────────────────────────────┘     │   │
│  │                           │                                   │   │
│  │                           ▼                                   │   │
│  │  ┌─────────────────────────────────────────────────────┐     │   │
│  │  │                   Processors                         │     │   │
│  │  │  - memory_limiter (prevent OOM)                     │     │   │
│  │  │  - filter (drop health check spans)                 │     │   │
│  │  │  - resource (add environment labels)                │     │   │
│  │  │  - batch (group spans for efficiency)               │     │   │
│  │  └─────────────────────────────────────────────────────┘     │   │
│  │                           │                                   │   │
│  │                           ▼                                   │   │
│  │  ┌─────────────────────────────────────────────────────┐     │   │
│  │  │                    Exporters                         │     │   │
│  │  │  - otlp/jaeger (send to Jaeger)                     │     │   │
│  │  │  - prometheus (trace metrics)                       │     │   │
│  │  └─────────────────────────────────────────────────────┘     │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                         Jaeger                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                   │   │
│  │  │    Collector    │  │     Query       │                   │   │
│  │  │  - Receives     │  │  - UI :16686    │                   │   │
│  │  │  - Validates    │  │  - Search       │                   │   │
│  │  │  - Stores       │  │  - Trace view   │                   │   │
│  │  └─────────────────┘  └─────────────────┘                   │   │
│  │            │                                                  │   │
│  │            ▼                                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐     │   │
│  │  │               Storage (In-Memory)                    │     │   │
│  │  │  - 50,000 traces max                                 │     │   │
│  │  │  - Production: Use Elasticsearch/Cassandra          │     │   │
│  │  └─────────────────────────────────────────────────────┘     │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Alert Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Alerting Pipeline                             │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      Prometheus                               │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  PrometheusRule: fineract-alert-rules                   │  │   │
│  │  │                                                          │  │   │
│  │  │  groups:                                                 │  │   │
│  │  │    - name: slo-burn-rate-alerts                         │  │   │
│  │  │      rules:                                              │  │   │
│  │  │        - alert: FineractAPIHighErrorBurnRate            │  │   │
│  │  │          expr: error_rate > 14.4 * 0.001                │  │   │
│  │  │          for: 2m                                         │  │   │
│  │  │          labels:                                         │  │   │
│  │  │            severity: critical                            │  │   │
│  │  │                                                          │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │                           │                                   │   │
│  │                           │ Alert fires                       │   │
│  │                           ▼                                   │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    AlertManager                               │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  route:                                                  │  │   │
│  │  │    receiver: default                                     │  │   │
│  │  │    routes:                                               │  │   │
│  │  │      - match: {severity: critical}                       │  │   │
│  │  │        receiver: critical-alerts                         │  │   │
│  │  │      - match: {component: database}                      │  │   │
│  │  │        receiver: database-alerts                         │  │   │
│  │  │                                                          │  │   │
│  │  │  receivers:                                              │  │   │
│  │  │    - name: critical-alerts                               │  │   │
│  │  │      slack_configs: [...]                                │  │   │
│  │  │      email_configs: [...]                                │  │   │
│  │  │                                                          │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │                           │                                   │   │
│  └───────────────────────────┼───────────────────────────────────┘   │
│                              │                                       │
│              ┌───────────────┼───────────────┐                      │
│              │               │               │                      │
│              ▼               ▼               ▼                      │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐          │
│  │     Slack      │ │     Email      │ │    Webhook     │          │
│  │ #fineract-     │ │ oncall@        │ │ auto-rollback  │          │
│  │ alerts-critical│ │ fineract.io    │ │ -webhook       │          │
│  └────────────────┘ └────────────────┘ └────────────────┘          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Namespace Organization

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Kubernetes Namespaces                            │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  monitoring                                                   │   │
│  │  ├── prometheus (StatefulSet, 1 replica)                     │   │
│  │  ├── grafana (Deployment, 1 replica)                         │   │
│  │  ├── alertmanager (StatefulSet, 1 replica)                   │   │
│  │  ├── prometheus-operator (Deployment)                        │   │
│  │  ├── ServiceMonitors (fineract, keycloak, redis, etc.)      │   │
│  │  ├── PodMonitors (fineract-pods, keycloak-pods)             │   │
│  │  └── PrometheusRules (alert-rules, slo-alerts)              │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  logging                                                      │   │
│  │  ├── loki (StatefulSet, 1 replica)                           │   │
│  │  └── promtail (DaemonSet, 1 per node)                        │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  tracing                                                      │   │
│  │  ├── jaeger (Deployment, 1 replica)                          │   │
│  │  └── otel-collector (Deployment, 1 replica)                  │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  fineract-dev / fineract-uat / fineract-prod                 │   │
│  │  ├── fineract-read (Deployment, 2 replicas)                  │   │
│  │  ├── fineract-write (Deployment, 2 replicas)                 │   │
│  │  ├── fineract-batch (Deployment, 1 replica)                  │   │
│  │  ├── keycloak (Deployment, 1 replica)                        │   │
│  │  ├── redis (StatefulSet, 1 replica)                          │   │
│  │  └── oauth2-proxy (Deployment, 1 replica)                    │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Storage Requirements

| Component | Storage | Retention | Type |
|-----------|---------|-----------|------|
| Prometheus | 50 GB | 30 days | PVC (SSD recommended) |
| Loki | 100 GB | 30 days | PVC (SSD recommended) |
| Jaeger | In-memory | ~50k traces | Memory (no persistence) |
| Grafana | 1 GB | N/A | PVC (dashboards, settings) |

## Network Ports

| Service | Port | Protocol | Purpose |
|---------|------|----------|---------|
| Prometheus | 9090 | HTTP | Web UI, API |
| Grafana | 3000 | HTTP | Web UI |
| AlertManager | 9093 | HTTP | Web UI, API |
| Loki | 3100 | HTTP | Push/Query API |
| Jaeger Query | 16686 | HTTP | Web UI |
| Jaeger Collector | 4317 | gRPC | OTLP receiver |
| Jaeger Collector | 4318 | HTTP | OTLP receiver |
| OTEL Collector | 4317 | gRPC | OTLP receiver |
| OTEL Collector | 4318 | HTTP | OTLP receiver |
