# NGINX Ingress-Based Endpoint Restriction Guide

This document provides a guide on how to implement endpoint restrictions for Fineract applications using the NGINX Ingress Controller on Kubernetes.

## 1. Introduction

This guide assumes you have a running Kubernetes cluster with the NGINX Ingress Controller and OAuth2 Proxy deployed. The goal is to restrict access to API endpoints based on user roles, which are provided by an OIDC provider (like Keycloak) and passed to the NGINX Ingress Controller as a header (`X-Auth-Request-Roles`).

## 2. Keycloak Role Configuration

1.  **Create Roles:** In your Keycloak realm, define roles that correspond to the application roles (e.g., `account-manager`, `accountant`, `admin`, `branch-manager`, `cashier`).
2.  **Assign Roles to Users/Groups:** Assign these roles to the appropriate users or groups.
3.  **Configure Client Scopes:** Ensure your OAuth2 Proxy is configured to request the roles from Keycloak and pass them in the `X-Auth-Request-Roles` header to the upstream services.

## 3. NGINX Ingress Configuration

The endpoint restrictions are implemented centrally in the global NGINX Ingress Controller ConfigMap, located at `fineract-gitops/apps/ingress-nginx/base/configmap.yaml`. This approach is clean, scalable, and the recommended way to manage access control.

The logic uses a chain of two `map` directives within the `http-snippet` section of the ConfigMap.

### 3.1. Step 1: Endpoint Categorization

The first map, `$endpoint_category`, takes the HTTP method and the request URI as input and maps them to a category. Categories typically correspond to a specific role or a group of roles that share access to an endpoint.

**Note:** Reporting endpoints are categorized as `public` and are accessible to all authenticated users.

Here is a snippet of the map:

```nginx
map "$request_method:$request_uri" $endpoint_category {
    default                                                     "public";

    # Account Manager Endpoints
    "~^POST:/fineract-provider/api/v1/clients$"                  "account-manager";
    # ... more account manager endpoints

    # Shared Endpoints
    "~^GET:/fineract-provider/api/v1/offices$"                   "common-offices";
    # ... more shared endpoints
}
```

### 3.2. Step 2: Role-Based Authorization

The second map, `$rbac_allowed`, takes the endpoint category (from the first map) and the user's roles (from the `$http_x_auth_request_roles` header) as input. It outputs `1` if the user is allowed access and `0` otherwise.

Here is a snippet of the map:

```nginx
map "$endpoint_category:$http_x_auth_request_roles" $rbac_allowed {
    default                                           0;

    "~^public:.*"                                     1;
    "~^account-manager:.*account-manager.*"           1;
    # ... rules for other roles

    # Shared Endpoint Permissions
    "~^common-offices:.*(account-manager|accountant|admin|branch-manager).*" 1;
    # ... rules for other shared endpoints
}
```

### 3.3. Step 3: Enforcing the Decision

The final piece is a small snippet in the Ingress resource (`fineract-gitops/apps/ingress/base/fineract-oauth2-protected.yaml`) that checks the result of the `$rbac_allowed` map and denies access if it's `0`.

```yaml
nginx.ingress.kubernetes.io/configuration-snippet: |
  if ($rbac_allowed = 0) {
    return 403;
  }
```

This setup ensures that all the complex authorization logic is centralized in the `configmap.yaml`, keeping the Ingress resources clean and simple.

## 4. Testing and Verification

To verify that the endpoint restrictions are being enforced by the Ingress Controller (and not just the application), you can perform the following checks.

### 4.1. Differentiating Ingress vs. Application Blocking

It is important to confirm *who* is blocking the request.
*   **Ingress Block (Correct):** If the Ingress blocks the request, you will receive a standard **HTML 403 Forbidden** page generated by Nginx. The body will often contain `<center>nginx</center>`.
*   **Application Block (Fallback):** If the request passes the Ingress but is blocked by Fineract (due to internal permissions), you will receive a **JSON** response (e.g., `{"developerMessage": "..."}`) with a 403 or 401 status.

### 4.2. Verification Steps

You can use `curl` to verify the restrictions by simulating requests with and without the required role headers.

#### Test 1: Verify Blocking (Cashier accessing unauthorized endpoint)

Try to access an **Accountant** endpoint (`/journalentries`) using a **Cashier** role. This should be blocked by the Ingress.

```bash
# Replace <LB_HOST> with your load balancer hostname
curl -k -v -H "X-Auth-Request-Roles: Cashier" https://<LB_HOST>/fineract-provider/api/v1/journalentries
```

**Expected Result:**
```
< HTTP/2 403
...
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx</center>
</body>
</html>
```

#### Test 2: Verify Access (Cashier accessing authorized endpoint)

Try to access a **Cashier** endpoint (`/userdetails`) using a **Cashier** role. This should be allowed by the Ingress.

```bash
curl -k -v -H "X-Auth-Request-Roles: Cashier" https://<LB_HOST>/fineract-provider/api/v1/userdetails
```

**Expected Result:**
You should receive a `302 Found` (redirect to login if no token is present) or a `200 OK` / `401 Unauthorized` JSON response from Fineract. **You should NOT receive the Nginx 403 HTML page.**

#### Test 3: Verify Security (Query Parameter Bypass Attempt)

Try to bypass the restrictions by adding query parameters to a restricted URL. This ensures the regex is correctly anchored and handles query strings securely.

```bash
# Attempt to access Account Manager endpoint with Cashier role using query params
curl -k -v -H "X-Auth-Request-Roles: Cashier" "https://<LB_HOST>/fineract-provider/api/v1/clients?offset=0"
```

**Expected Result:**
This should be **BLOCKED** by Ingress (403 Forbidden HTML), confirming that adding `?offset=0` does not bypass the security rule.

### 4.3. Troubleshooting

If you are not seeing the Nginx 403 page:
1.  **Check ConfigMap:** Ensure `fineract-gitops/apps/ingress-nginx/base/configmap.yaml` is applied and contains the `http-snippet`.
2.  **Check Ingress Resource:** Verify your Ingress resource has the enforcement logic in the `configuration-snippet` annotation:
    ```nginx
    if ($rbac_allowed = 0) {
      return 403;
    }
    ```
