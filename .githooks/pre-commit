#!/bin/bash

# Pre-commit hook for Fineract GitOps
#
# This hook performs local validation before committing changes.
# It helps catch issues early and speeds up development by providing
# immediate feedback without waiting for CI/CD pipelines.
#
# To bypass this hook (not recommended):
#   git commit --no-verify

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}================================${NC}"
echo -e "${BLUE}Running pre-commit checks...${NC}"
echo -e "${BLUE}================================${NC}"
echo ""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

cd "$PROJECT_ROOT"

# Track if any checks fail
CHECKS_FAILED=0

# =============================================================================
# Check 1: Secret Detection
# =============================================================================
echo -e "${BLUE}[1/4] Checking for secrets...${NC}"

if [ -f "scripts/validate-secrets.sh" ]; then
    if ./scripts/validate-secrets.sh > /dev/null 2>&1; then
        echo -e "${GREEN}✓ No secrets detected${NC}"
    else
        echo -e "${RED}✗ Secret detection failed${NC}"
        echo -e "${YELLOW}Run: ./scripts/validate-secrets.sh for details${NC}"
        CHECKS_FAILED=1
    fi
else
    echo -e "${YELLOW}⚠ Secret validation script not found, skipping${NC}"
fi

echo ""

# =============================================================================
# Check 2: Block :latest tags in production files
# =============================================================================
echo -e "${BLUE}[2/4] Checking for :latest tags in production...${NC}"

# Check if any production files are being committed
PROD_FILES=$(git diff --cached --name-only | grep -E "environments/production|argocd/applications/production" || true)

if [ -n "$PROD_FILES" ]; then
    # Check if any of these files contain :latest
    if git diff --cached | grep -E "^\+.*:latest" | grep -qv "imagePullPolicy"; then
        echo -e "${RED}✗ Found :latest tags in production files${NC}"
        echo -e "${YELLOW}Files being committed:${NC}"
        echo "$PROD_FILES"
        echo ""
        echo -e "${YELLOW}Lines with :latest:${NC}"
        git diff --cached | grep -E "^\+.*:latest" | grep -v "imagePullPolicy" || true
        echo ""
        echo -e "${RED}ERROR: :latest tags are not allowed in production files${NC}"
        echo -e "${YELLOW}Please pin images to specific versions${NC}"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}✓ No :latest tags in production files${NC}"
    fi
else
    echo -e "${GREEN}✓ No production files being committed${NC}"
fi

echo ""

# =============================================================================
# Check 3: Kustomize Build Validation
# =============================================================================
echo -e "${BLUE}[3/4] Validating kustomize builds...${NC}"

if [ -f "scripts/validate-locally.sh" ]; then
    if ./scripts/validate-locally.sh > /dev/null 2>&1; then
        echo -e "${GREEN}✓ All kustomize builds pass${NC}"
    else
        echo -e "${RED}✗ Kustomize validation failed${NC}"
        echo -e "${YELLOW}Run: ./scripts/validate-locally.sh for details${NC}"
        CHECKS_FAILED=1
    fi
else
    # Fallback to manual kustomize validation if script doesn't exist
    echo -e "${YELLOW}Validation script not found, running manual kustomize builds...${NC}"

    BUILD_FAILED=0
    for env in dev uat production; do
        if [ -d "environments/$env" ]; then
            if kubectl kustomize "environments/$env" > /dev/null 2>&1; then
                echo -e "${GREEN}✓ environments/$env builds successfully${NC}"
            else
                echo -e "${RED}✗ environments/$env build failed${NC}"
                BUILD_FAILED=1
            fi
        fi
    done

    if [ $BUILD_FAILED -eq 1 ]; then
        CHECKS_FAILED=1
    fi
fi

echo ""

# =============================================================================
# Check 4: YAML Linting (Optional - only if yamllint is installed)
# =============================================================================
echo -e "${BLUE}[4/4] Linting YAML files...${NC}"

if command -v yamllint &> /dev/null; then
    # Get list of YAML files being committed
    YAML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yaml|yml)$' || true)

    if [ -n "$YAML_FILES" ]; then
        if echo "$YAML_FILES" | xargs yamllint -d relaxed > /dev/null 2>&1; then
            echo -e "${GREEN}✓ YAML files are properly formatted${NC}"
        else
            echo -e "${YELLOW}⚠ YAML linting found issues (non-blocking)${NC}"
            echo -e "${YELLOW}Run: yamllint <file> for details${NC}"
            # Note: Don't fail the commit for linting issues
        fi
    else
        echo -e "${GREEN}✓ No YAML files being committed${NC}"
    fi
else
    echo -e "${YELLOW}⚠ yamllint not installed, skipping${NC}"
    echo -e "${YELLOW}Install with: brew install yamllint (macOS) or pip install yamllint${NC}"
fi

echo ""
echo -e "${BLUE}================================${NC}"

# =============================================================================
# Final Result
# =============================================================================
if [ $CHECKS_FAILED -eq 1 ]; then
    echo -e "${RED}✗ Pre-commit checks FAILED${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues above or bypass with:${NC}"
    echo -e "${YELLOW}  git commit --no-verify${NC}"
    echo ""
    echo -e "${RED}Note: GitHub Actions will still enforce these checks${NC}"
    echo -e "${BLUE}================================${NC}"
    exit 1
else
    echo -e "${GREEN}✓ All pre-commit checks PASSED${NC}"
    echo -e "${BLUE}================================${NC}"
    exit 0
fi
