apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
type: Opaque
stringData:
  alertmanager.yaml: |
    # AlertManager Configuration for Dev Environment
    # External notifications (Slack/Email) are disabled
    # For production, create an overlay with proper credentials

    global:
      resolve_timeout: 5m

    # Routing tree
    route:
      # Default receiver
      receiver: 'default'

      # Group alerts by these labels
      group_by: ['alertname', 'cluster', 'service', 'namespace']

      # Wait before sending notification for new group
      group_wait: 30s

      # Wait before sending notification about new alerts in group
      group_interval: 5m

      # Wait before sending notification again if alert still firing
      repeat_interval: 4h

      # Child routes
      routes:
      # Auto-rollback alerts - webhook to ArgoCD
      - match:
          auto_rollback: enabled
        receiver: auto-rollback-webhook
        group_wait: 10s
        group_interval: 1m
        repeat_interval: 15m
        continue: true

      # Critical alerts
      - match:
          severity: critical
        receiver: 'default'
        group_wait: 10s
        repeat_interval: 1h

      # Warning alerts
      - match:
          severity: warning
        receiver: 'default'
        repeat_interval: 4h

    # Alert receivers
    receivers:
    # Default receiver - no external notifications in dev
    # Alerts are visible in AlertManager UI
    - name: 'default'
      # For production, add slack_configs or email_configs here
      # Example:
      # slack_configs:
      # - api_url: 'https://hooks.slack.com/services/...'
      #   channel: '#fineract-alerts'
      #   send_resolved: true

    # Auto-rollback webhook for ArgoCD integration
    - name: 'auto-rollback-webhook'
      webhook_configs:
      - url: 'http://auto-rollback-webhook.argocd.svc.cluster.local:8080/alerts'
        send_resolved: false
        max_alerts: 10

    # Inhibition rules - suppress alerts if others are firing
    inhibit_rules:
    # Suppress warning if critical is firing
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'cluster', 'service']

    # Suppress individual pod alerts if deployment is down
    - source_match:
        alertname: 'DeploymentDown'
      target_match:
        alertname: 'PodDown'
      equal: ['deployment']
