apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: fineract-production

resources:
  - ../../base

# Override hostname and certificate configuration for production environment
configMapGenerator:
  - name: ingress-config
    behavior: replace
    literals:
      - apps-hostname=apps.fineract.com
      - auth-hostname=auth.fineract.com
      - cluster-issuer=letsencrypt-prod  # Production uses Let's Encrypt trusted certificates

commonLabels:
  environment: production
  deployment-type: aws
  managed-by: argocd
  criticality: high

# Patches to fix hardcoded namespace references
patches:
  # Fix OAuth2 Proxy auth-url for fineract-oauth2-protected
  - target:
      kind: Ingress
      name: fineract-oauth2-protected
    patch: |-
      - op: replace
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-url
        value: "http://oauth2-proxy.fineract-production.svc.cluster.local:4180/oauth2/auth"

  # Fix OAuth2 Proxy auth-url for fineract-oauth2-protected-write-canary
  - target:
      kind: Ingress
      name: fineract-oauth2-protected-write-canary
    patch: |-
      - op: replace
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-url
        value: "http://oauth2-proxy.fineract-production.svc.cluster.local:4180/oauth2/auth"

  # Fix OAuth2 Proxy auth-url for fineract-web-app-protected
  - target:
      kind: Ingress
      name: fineract-web-app-protected
    patch: |-
      - op: replace
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-url
        value: "http://oauth2-proxy.fineract-production.svc.cluster.local:4180/oauth2/auth"

  # Fix OAuth2 Proxy auth-url and server-snippet backends for fineract-web-app-root
  - target:
      kind: Ingress
      name: fineract-web-app-root
    patch: |-
      - op: replace
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-url
        value: "http://oauth2-proxy.fineract-production.svc.cluster.local:4180/oauth2/auth"
      - op: replace
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1server-snippet
        value: |
          # Static file requests routing with OAuth2 bypass
          set $backend "web-app.fineract-production.svc.cluster.local:80";
          if ($request_uri ~* ^/mifosweb) {
            set $backend "web-app.fineract-production.svc.cluster.local:80";
          }
          if ($request_uri ~* ^/reporting) {
            set $backend "reporting-app.fineract-production.svc.cluster.local:80";
          }
          if ($request_uri ~* ^/accounting) {
            set $backend "accounting-app.fineract-production.svc.cluster.local:80";
          }

          # Skip OAuth2 authentication for static file requests
          location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|map|json)$ {
            auth_request off;
            proxy_pass http://web-app.fineract-production.svc.cluster.local:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
          }

          # App-specific static asset routes
          location ~* ^/mifosweb/.*\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|map|json)$ {
            auth_request off;
            proxy_pass http://reporting-app.fineract-production.svc.cluster.local:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
          }
          location ~* ^/reporting/.*\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|map|json)$ {
            auth_request off;
            proxy_pass http://reporting-app.fineract-production.svc.cluster.local:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
          }
          location ~* ^/accounting/.*\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|map|json)$ {
            auth_request off;
            proxy_pass http://accounting-app.fineract-production.svc.cluster.local:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
          }
