---
# OAuth2 Proxy Public Endpoints (no authentication required)
# This ingress handles OAuth2 flow endpoints that must be accessible without auth
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fineract-oauth2-public
  labels:
    app: fineract
    component: ingress
    purpose: oauth2-public-endpoints
  annotations:
    # SSL/TLS Configuration
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"

    # cert-manager - automatic certificate management
    cert-manager.io/cluster-issuer: "cluster-issuer"

    # Backend protocol
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"

    # Configuration snippet to handle logout and proxy headers
    # This runs INSIDE the /oauth2 location block, before proxying to backend
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Forwarded-Host: $host";
      more_set_headers "X-Forwarded-Port: 443";
      more_set_headers "X-Forwarded-Proto: https";

      # Determine which app to redirect to after logout (default to web-app)
      set $post_logout_app "web-app";
      if ($http_referer ~* "^https://[^/]+/(cashier|web-app|accounting-app|admin-app|reporting-app|branch-manager-app|account-manager-app)/") {
        set $post_logout_app $1;
      }

      # Intercept sign_out requests and redirect to Keycloak for SSO logout
      # Clear OAuth2 Proxy cookie with multiple variations to ensure it's removed
      if ($request_uri ~* "^/oauth2/sign_out") {
        more_clear_headers "Set-Cookie";
        add_header Set-Cookie "_oauth2_proxy=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy=; Path=/; Domain=$host; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy_csrf=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=Lax" always;
        return 302 https://$host/realms/fineract/protocol/openid-connect/logout?client_id=fineract-oauth2-proxy&post_logout_redirect_uri=https%3A%2F%2F$host%2F$post_logout_app%2F;
      }

spec:
  ingressClassName: nginx

  tls:
  - hosts:
    - apps-hostname
    secretName: fineract-tls

  rules:
  - host: apps-hostname
    http:
      paths:

      # OAuth2 Proxy endpoints (no auth required for OAuth flow)
      - path: /oauth2
        pathType: Prefix
        backend:
          service:
            name: oauth2-proxy
            port:
              number: 4180