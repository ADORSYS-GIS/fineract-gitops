apiVersion: v1
kind: ConfigMap
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
data:
  # ============================================================================
  # Security Configuration
  # ============================================================================

  # Allow snippet annotations (required for advanced ingress configurations)
  # NOTE: Enable only if you trust all users who can create Ingress resources
  allow-snippet-annotations: "true"

  # ============================================================================
  # General Nginx Configuration
  # ============================================================================

  # Enable real IP forwarding (important for K3s and cloud load balancers)
  use-forwarded-headers: "true"
  compute-full-forwarded-for: "true"

  # Proxy settings
  proxy-body-size: "50m"
  proxy-connect-timeout: "600"
  proxy-read-timeout: "600"
  proxy-send-timeout: "600"

  # Client settings
  client-header-buffer-size: "64k"
  large-client-header-buffers: "4 64k"

  # SSL/TLS settings
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
  ssl-prefer-server-ciphers: "true"

  # HSTS (HTTP Strict Transport Security)
  hsts: "true"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "true"
  hsts-preload: "true"

  # Security headers (global defaults, can be overridden per-ingress)
  add-headers: "ingress-nginx/custom-headers"

  # Logging
  log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id $http_x_auth_request_user'

  # ============================================================================
  # Read/Write Routing Logic
  # ============================================================================

  # Map block for determining backend service based on HTTP method
  # This will be used in Ingress annotations via configuration-snippet
  http-snippet: |
      # Map HTTP method to backend service for read/write separation
      map $request_method $fineract_backend {
          GET     "fineract-read-service.fineract-dev.svc.cluster.local:8080";
          HEAD    "fineract-read-service.fineract-dev.svc.cluster.local:8080";
          OPTIONS "fineract-read-service.fineract-dev.svc.cluster.local:8080";
          default "fineract-write-service.fineract-dev.svc.cluster.local:8080";
      }
  
      # Map for admin endpoints (always route to write service)
      map $request_uri $is_admin_endpoint {
          default 0;
          "~^/fineract-provider/api/v1/users"                 1;
          "~^/fineract-provider/api/v1/permissions"           1;
          "~^/fineract-provider/api/v1/roles"                 1;
          "~^/fineract-provider/api/v1/codes"                 1;
          "~^/fineract-provider/api/v1/hooks"                 1;
          "~^/fineract-provider/api/v1/jobs"                  1;
          "~^/fineract-provider/api/v1/configurations"        1;
          "~^/fineract-provider/api/v1/systemconfig"          1;
          "~^/fineract-provider/api/v1/datatables"            1;
          "~^/fineract-provider/api/v1/entitytoentitymapping" 1;
          "~^/fineract-provider/api/v1/globalconfig"          1;
      }
  
      # Determine final backend service
      map $is_admin_endpoint $final_backend {
          1       "fineract-write-service.fineract-dev.svc.cluster.local:8080";
          default $fineract_backend;
      }
  
      # OAuth2 Proxy auth endpoint
      map $request_uri $oauth2_proxy_auth_url {
          default "http://oauth2-proxy.fineract-dev.svc.cluster.local:4180/oauth2/auth";
      }
  
      # Rate limiting zones
      limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
      limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/s;
  
      # ============================================================================
      # RBAC Endpoint Categorization
      # ============================================================================
  
      map "$request_method:$request_uri" $endpoint_category {
          default                                                     "public";
  
          # Account Manager Endpoints
          "~^POST:/fineract-provider/api/v1/authentication$"           "account-manager";
          "~^POST:/fineract-provider/api/v1/clients$"                  "account-manager";
          "~^GET:/fineract-provider/api/v1/runreports/Savings%20Transactions$" "account-manager";
          "~^GET:/fineract-provider/api/v1/clients/[^/]+/accounts$"    "account-manager";
          "~^POST:/fineract-provider/api/v1/savingsaccounts/[^/]+\?command=activate$" "account-manager";
          "~^DELETE:/fineract-provider/api/v1/loans/[^/]+$"            "account-manager";
          "~^DELETE:/fineract-provider/api/v1/savingsaccounts/[^/]+$"  "account-manager";
          "~^GET:/fineract-provider/api/v1/clients/[^/]+/images$"      "account-manager";
          "~^POST:/fineract-provider/api/v1/clients/[^/]+/images$"     "account-manager";
          "~^DELETE:/fineract-provider/api/v1/clients/[^/]+/images$"   "account-manager";
          "~^GET:/fineract-provider/api/v1/clients$"                   "account-manager";
          "~^POST:/fineract-provider/api/v2/clients/search$"           "account-manager";
          "~^POST:/fineract-provider/api/v1/loans$"                    "account-manager";
          "~^PUT:/fineract-provider/api/v1/loans/[^/]+$"               "account-manager";
          "~^GET:/fineract-provider/api/v1/loans/template$"            "account-manager";
          "~^POST:/fineract-provider/api/v1/loans\?command=calculateLoanSchedule$" "account-manager";
          "~^GET:/fineract-provider/api/v1/savingsproducts$"           "account-manager";
          "~^GET:/fineract-provider/api/v1/loanproducts$"              "account-manager";
          "~^GET:/fineract-provider/api/v1/products/[^/]+$"            "account-manager";
          "~^GET:/fineract-provider/api/v1/recurringdepositproducts$"  "account-manager";
          "~^GET:/fineract-provider/api/v1/fixeddepositproducts$"      "account-manager";
          "~^POST:/fineract-provider/api/v1/savingsaccounts$"          "account-manager";
          "~^POST:/fineract-provider/api/v1/accounts/[^/]+$"           "account-manager";
          "~^POST:/fineract-provider/api/v1/savingsaccounts/[^/]+\?command=unblock$" "account-manager";
          "~^GET:/fineract-provider/api/v1/codes/[^/]+/codevalues$"    "account-manager";
          "~^POST:/fineract-provider/api/v1/savingsaccounts/[^/]+\?command=block$" "account-manager";
  
          # Accountant Endpoints
          "~^GET:/fineract-provider/api/v1/makercheckers$"             "accountant";
          "~^POST:/fineract-provider/api/v1/glclosures$"               "accountant";
          "~^GET:/fineract-provider/api/v1/glaccounts$"                "accountant";
          "~^POST:/fineract-provider/api/v1/journalentries$"           "accountant";
          "~^GET:/fineract-provider/api/v1/journalentries$"            "accountant";
          "~^DELETE:/fineract-provider/api/v1/glaccounts/[^/]+$"       "accountant";
          "~^GET:/fineract-provider/api/v1/journalentries/[^/]+$"      "accountant";
          "~^POST:/fineract-provider/api/v1/journalentries/[^/]+$"     "accountant";
          "~^POST:/fineract-provider/api/v1/makercheckers/[^/]+$"      "accountant";
  
          # Admin Endpoints
          "~^POST:/fineract-provider/api/v1/adorsys/employees$"        "admin";
          "~^GET:/fineract-provider/api/v1/adorsys/employees$"         "admin";
          "~^GET:/fineract-provider/api/v1/adorsys/employees/[^/]+$"   "admin";
          "~^PUT:/fineract-provider/api/v1/adorsys/employees/[^/]+$"   "admin";
          "~^POST:/fineract-provider/api/user-sync/sync/user$"         "admin";
          "~^POST:/fineract-provider/api/user-sync/users/[^/]+/reset-password$" "admin";
          "~^PUT:/fineract-provider/api/user-sync/users/[^/]+/status$" "admin";
          "~^POST:/fineract-provider/api/user-sync/users/[^/]+/force-password-change$" "admin";
          "~^GET:/fineract-provider/api/user-sync/users/[^/]+/keycloak-status$" "admin";
          "~^GET:/fineract-provider/api/v1/roles$"                     "admin";
          "~^GET:/fineract-provider/api/v1/users$"                     "admin";
  
          # Branch Manager Endpoints
          "~^GET:/fineract-provider/api/v1/savingsaccounts$"           "branch-manager";
          "~^POST:/fineract-provider/api/v1/savingsaccounts/[^/]+\?command=approve$" "branch-manager";
          "~^POST:/fineract-provider/api/v1/tellers/[^/]+/cashiers/[^/]+/allocate$" "branch-manager";
          "~^POST:/fineract-provider/api/v1/tellers/[^/]+/cashiers/[^/]+/settle$" "branch-manager";
          "~^GET:/fineract-provider/api/v1/tellers/[^/]+/cashiers/[^/]+$" "branch-manager";
          "~^GET:/fineract-provider/api/v1/tellers/[^/]+/cashiers/[^/]+/summaryandtransactions$" "branch-manager";
          "~^GET:/fineract-provider/api/v1/tellers/[^/]+/cashiers$"    "branch-manager";
          "~^POST:/fineract-provider/api/v1/loans/[^/]+\?command=approve$" "branch-manager";
          "~^POST:/fineract-provider/api/v1/loans/[^/]+\?command=reject$" "branch-manager";
          "~^GET:/fineract-provider/api/v1/staff$"                     "branch-manager";
          "~^GET:/fineract-provider/api/v1/staff/[^/]+$"               "branch-manager";
          "~^GET:/fineract-provider/api/v1/tellers/[^/]+/cashiers/template$" "branch-manager";
          "~^GET:/fineract-provider/api/v1/tellers/[^/]+$"             "branch-manager";
          "~^POST:/fineract-provider/api/v1/tellers/[^/]+/cashiers$"   "branch-manager";
          "~^POST:/fineract-provider/api/v1/tellers$"                  "branch-manager";
  
          # Cashier Endpoints
          "~^GET:/fineract-provider/api/v1/userdetails$"               "cashier";
          "~^POST:/fineract-provider/api/v1/savingsaccounts/[^/]+/transactions$" "cashier";
          "~^POST:/fineract-provider/api/v1/loans/[^/]+/transactions$" "cashier";
  
          # Shared Endpoints - These are accessible by multiple roles
          "~^GET:/fineract-provider/api/v1/offices$"                   "common-offices";
          "~^GET:/fineract-provider/api/v1/currencies$"                "common-currencies";
          "~^GET:/fineract-provider/api/v1/paymenttypes$"              "common-paymenttypes";
          "~^GET:/fineract-provider/api/v1/tellers$"                   "common-tellers";
          "~^GET:/fineract-provider/api/v1/savingsaccounts/[^/]+$"     "common-savingsaccounts-read";
          "~^GET:/fineract-provider/api/v1/clients/[^/]+$"             "common-clients-read";
          "~^GET:/fineract-provider/api/v1/loans/[^/]+$"               "common-loans-read";
      }
  
      # Check if user has required role for endpoint category
      map "$endpoint_category:$http_x_auth_request_roles" $rbac_allowed {
          default                                           0;
  
          # Public endpoints are accessible by any authenticated user
          "~^public:.*"                                     1;
  
          # Role-specific endpoint permissions
          "~^account-manager:.*account-manager.*"           1;
          "~^accountant:.*accountant.*"                     1;
          "~^admin:.*admin.*"                               1;
          "~^branch-manager:.*branch-manager.*"             1;
          "~^cashier:.*cashier.*"                           1;
  
          # Shared Endpoint Permissions
          "~^common-offices:.*(account-manager|accountant|admin|branch-manager).*" 1;
          "~^common-currencies:.*(accountant|cashier).*"     1;
          "~^common-paymenttypes:.*(accountant|cashier).*"   1;
          "~^common-tellers:.*(branch-manager|cashier).*"    1;
          "~^common-savingsaccounts-read:.*(account-manager|branch-manager|cashier).*" 1;
          "~^common-clients-read:.*(account-manager|branch-manager).*" 1;
          "~^common-loans-read:.*(account-manager|branch-manager).*" 1;
      }

  # ============================================================================
  # Performance Tuning
  # ============================================================================

  # Worker processes
  worker-processes: "auto"
  worker-connections: "10240"

  # Keepalive
  keep-alive: "75"
  keep-alive-requests: "100"

  # Buffers
  proxy-buffer-size: "128k"
  proxy-buffers: "4 256k"
  proxy-busy-buffers-size: "256k"

  # Enable gzip compression
  use-gzip: "true"
  gzip-level: "5"
  gzip-types: "application/json application/javascript text/css text/plain text/xml application/xml"

  # Enable Brotli compression (more efficient than gzip for text)
  enable-brotli: "true"
  brotli-level: "6"
  brotli-types: "application/json application/javascript text/css text/plain text/xml application/xml"

  # ============================================================================
  # Caching Configuration
  # ============================================================================

  # Proxy cache configuration for static assets
  proxy-cache-path: "/tmp/nginx-cache levels=1:2 keys_zone=static_cache:10m max_size=100m inactive=60m use_temp_path=off"
  proxy-cache-valid: "200 302 60m"
  proxy-cache-valid-404: "1m"
  proxy-cache-use-stale: "error timeout updating http_500 http_502 http_503 http_504"
  proxy-cache-lock: "on"
  proxy-cache-lock-timeout: "5s"

  # ============================================================================
  # Monitoring and Observability
  # ============================================================================

  # Enable Prometheus metrics
  enable-opentelemetry: "false"

  # Custom error pages (optional)
  # custom-http-errors: "404,503"
