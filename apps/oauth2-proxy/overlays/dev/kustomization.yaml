apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: fineract-dev

resources:
  - ../../base

commonLabels:
  environment: dev
  infrastructure: aws
  provider: aws-managed

# Override image to v7.6.0 which added --skip-claims-from-profile-url support
images:
- name: quay.io/oauth2-proxy/oauth2-proxy
  newTag: v7.6.0

# No configMapGenerator needed for ingress-config
# Domain values are centralized in apps/ingress/overlays/dev/kustomization.yaml
# and automatically updated by scripts/auto-update-lb-dns.sh
# OAuth2 Proxy init container reads these and builds full URLs at runtime

# Static configuration (realm name)
# Use 'replace' behavior to override the base ConfigMap generator
configMapGenerator:
  - name: oauth2-proxy-config-static
    behavior: replace
    literals:
      - REALM_NAME=fineract

# Patch deployment to build URLs dynamically from ingress-config domains
patches:
  # Patch wait-for-fineract-realm init container to validate frontendUrl matches LoadBalancer DNS
  # This prevents race condition where OAuth2-Proxy starts before keycloak-config job completes
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: oauth2-proxy
      spec:
        template:
          spec:
            initContainers:
            - name: wait-for-fineract-realm
              volumeMounts:
              - name: ingress-config
                mountPath: /ingress-config
                readOnly: true
              command:
              - sh
              - -c
              - |
                echo "========================================="
                echo "Waiting for Keycloak Realm Configuration"
                echo "========================================="
                echo "This waits for keycloak-config job to fully configure the realm"
                echo "AND validates that frontendUrl matches expected LoadBalancer DNS."
                echo ""

                # Read expected hostname from ingress-config (single source of truth)
                EXPECTED_HOST=$(cat /ingress-config/apps-hostname)
                echo "Expected LoadBalancer DNS: $EXPECTED_HOST"
                echo ""

                MAX_RETRIES=90  # 7.5 minutes
                RETRY_COUNT=0

                until [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
                  # Fetch OIDC discovery configuration
                  OIDC_CONFIG=$(curl -f -s http://keycloak-service:8080/auth/realms/fineract/.well-known/openid-configuration 2>/dev/null || echo "")

                  if [ -n "$OIDC_CONFIG" ]; then
                    # Extract authorization_endpoint from OIDC discovery
                    AUTH_ENDPOINT=$(echo "$OIDC_CONFIG" | grep -o '"authorization_endpoint":"[^"]*"' | head -1)

                    # Verify auth endpoint contains the EXPECTED hostname (not just "not localhost")
                    # This prevents race condition where old frontendUrl from database is used
                    if echo "$AUTH_ENDPOINT" | grep -q "$EXPECTED_HOST"; then
                      echo "✓ Keycloak realm frontendUrl matches expected LoadBalancer DNS!"
                      echo "  $AUTH_ENDPOINT"
                      echo ""
                      echo "Keycloak realm 'fineract' is ready for OAuth2 Proxy!"
                      echo "========================================="
                      exit 0
                    elif echo "$AUTH_ENDPOINT" | grep -q "localhost"; then
                      echo "⚠  Realm exists but frontendUrl uses localhost (keycloak-config job not started yet)..."
                    else
                      echo "⚠  Realm exists but frontendUrl doesn't match expected LoadBalancer DNS"
                      echo "   Expected: $EXPECTED_HOST"
                      echo "   Got: $AUTH_ENDPOINT"
                      echo "   Waiting for keycloak-config job to apply correct configuration..."
                    fi
                  fi

                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  echo "Waiting for realm configuration (attempt $RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 5
                done

                echo "❌ Timeout waiting for Keycloak realm configuration"
                echo "This likely means the keycloak-config job has not completed successfully"
                echo "or the frontendUrl doesn't match expected LoadBalancer DNS."
                echo ""
                echo "Expected hostname: $EXPECTED_HOST"
                echo "Check the apply-keycloak-config job logs for errors."
                exit 1
    target:
      kind: Deployment
      name: oauth2-proxy

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: oauth2-proxy
      spec:
        template:
          spec:
            # Init container to build URLs from domain configuration and substitute in config file
            initContainers:
            - name: envsubst-config
              image: alpine:3.18
              securityContext:
                runAsUser: 0
                runAsNonRoot: false
              command:
                - sh
                - -c
                - |
                  # Install gettext for envsubst command
                  apk add --no-cache gettext

                  echo "===================================="
                  echo "Building OAuth2 Proxy URLs from centralized domain configuration"
                  echo "===================================="

                  # Read domain values from ingress-config (single source of truth)
                  APPS_DOMAIN=$(cat /ingress-config/apps-hostname)
                  AUTH_DOMAIN=$(cat /ingress-config/auth-hostname)
                  REALM_NAME=$(cat /static-config/REALM_NAME)

                  # Build full URLs from domain components
                  # DEV: Use internal Keycloak service for OIDC discovery (no DNS/certs for ELB)
                  # OAuth2 Proxy runs inside cluster and can access Keycloak directly
                  # Browsers will access Keycloak via the ELB hostname for login redirects
                  export OIDC_ISSUER_URL="http://keycloak-service:8080/auth/realms/${REALM_NAME}"
                  export REDIRECT_URL="https://${APPS_DOMAIN}/oauth2/callback"
                  export WHITELIST_DOMAINS="${APPS_DOMAIN}"
                  export COOKIE_DOMAINS="${APPS_DOMAIN}"

                  echo "Domain configuration:"
                  echo "  APPS_DOMAIN: ${APPS_DOMAIN}"
                  echo "  AUTH_DOMAIN: ${AUTH_DOMAIN}"
                  echo "  REALM_NAME: ${REALM_NAME}"
                  echo ""
                  echo "Generated URLs:"
                  echo "  OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}"
                  echo "  REDIRECT_URL: ${REDIRECT_URL}"
                  echo "  WHITELIST_DOMAINS: ${WHITELIST_DOMAINS}"
                  echo "  COOKIE_DOMAINS: ${COOKIE_DOMAINS}"
                  echo ""

                  # Substitute environment variables in config file
                  echo "Substituting variables in OAuth2 Proxy configuration..."
                  envsubst < /config-template/oauth2_proxy.cfg > /config-processed/oauth2_proxy.cfg
                  echo "Configuration file generated successfully."
                  echo "===================================="
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"
              volumeMounts:
              - name: config
                mountPath: /config-template
                readOnly: true
              - name: config-processed
                mountPath: /config-processed
              - name: ingress-config
                mountPath: /ingress-config
                readOnly: true
              - name: static-config
                mountPath: /static-config
                readOnly: true

            # Update main container to use processed config and add skip-claims flag
            containers:
            - name: oauth2-proxy
              # Add --skip-claims-from-profile-url flag to prevent userinfo endpoint fetch
              # This fixes the 401 error when oauth2-proxy tries to fetch groups from Keycloak's userinfo endpoint
              # Note: Requires v7.6.0+ (see images section at top of file)
              args:
              - --config=/etc/oauth2-proxy/oauth2_proxy.cfg
              - --email-domain=*
              - --skip-claims-from-profile-url=true
              - --insecure-oidc-allow-unverified-email=true
              volumeMounts:
              - name: config-processed
                mountPath: /etc/oauth2-proxy
                readOnly: true

            # Add volumes for configuration
            volumes:
            - name: config-processed
              emptyDir: {}
            - name: ingress-config
              configMap:
                name: ingress-config
            - name: static-config
              configMap:
                name: oauth2-proxy-config-static
    target:
      kind: Deployment
      name: oauth2-proxy

  # Patch ConfigMap to allow SSL skip verification for dev self-signed certs
  - patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: oauth2-proxy-config
      data:
        oauth2_proxy.cfg: |
          # ============================================================================
          # HTTP Server Configuration
          # ============================================================================
          http_address = "0.0.0.0:4180"
          https_address = ""
          reverse_proxy = true

          # ============================================================================
          # OIDC Provider Configuration (Keycloak)
          # ============================================================================
          provider = "oidc"
          provider_display_name = "Fineract Keycloak"
          oidc_issuer_url = "${OIDC_ISSUER_URL}"
          skip_oidc_discovery = false
          insecure_oidc_skip_issuer_verification = true
          oidc_email_claim = "email"
          # Disabled: oidc_groups_claim causes userinfo fetch even with skip_userinfo
          # Roles are passed via JWT token and handled by backend apps
          # oidc_groups_claim = "realm_access.roles"
          extra_jwt_issuers = ""

          # ============================================================================
          # Redirect and Callback Configuration
          # ============================================================================
          redirect_url = "${REDIRECT_URL}"
          whitelist_domains = "${WHITELIST_DOMAINS}"

          # ============================================================================
          # Cookie Configuration
          # ============================================================================
          cookie_name = "_oauth2_proxy"
          cookie_secure = true
          cookie_httponly = true
          cookie_samesite = "lax"
          cookie_domains = "${COOKIE_DOMAINS}"
          cookie_expire = "4h"
          cookie_refresh = "20m"

          # ============================================================================
          # Session Configuration
          # ============================================================================
          session_store_type = "redis"

          # ============================================================================
          # Email and Authorization
          # ============================================================================
          email_domains = "*"
          skip_auth_routes = [
            "^/ping$",
            "^/ready$",
            "^/.*\\.(js|css|json|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$",
          ]

          # ============================================================================
          # Upstream Configuration
          # ============================================================================
          upstreams = []

          # ============================================================================
          # Headers and Request Flow
          # ============================================================================
          set_xauthrequest = true
          set_authorization_header = true
          pass_authorization_header = true
          pass_access_token = true
          pass_user_headers = true

          # ============================================================================
          # Logging Configuration
          # ============================================================================
          logging_filename = ""
          logging_max_size = 100
          logging_max_age = 7
          logging_max_backups = 0
          logging_local_time = true
          logging_compress = false
          standard_logging = true
          auth_logging = true
          request_logging = true

          # ============================================================================
          # Security Configuration - DEV OVERRIDE
          # ============================================================================
          # SECURITY NOTE: Dev environment uses self-signed certificates
          # This setting is ONLY for development - production uses false (from base)
          ssl_insecure_skip_verify = true
          force_https = false

          # ============================================================================
          # Scope Configuration
          # ============================================================================
          scope = "openid profile email roles offline_access"

          # ============================================================================
          # Metrics and Health
          # ============================================================================
          metrics_address = "0.0.0.0:9090"
          ping_path = "/ping"
          ready_path = "/ready"

          # ============================================================================
          # Banner and UI
          # ============================================================================
          custom_sign_in_logo = ""
          footer = "Fineract Platform - Secured by OAuth2 Proxy"

          # ============================================================================
          # Advanced Configuration
          # ============================================================================
          skip_jwt_bearer_tokens = false
          allowed_groups = []
          real_client_ip_header = "X-Forwarded-For"
          silence_ping_logging = true
    target:
      kind: ConfigMap
      name: oauth2-proxy-config
