# =============================================================================
# OAuth2-Proxy Configuration for Local Development
# Adapted from apps/oauth2-proxy/base/configmap.yaml
# =============================================================================

# HTTP Server Configuration
http_address = "0.0.0.0:4180"
https_address = ""
reverse_proxy = true

# OIDC Provider Configuration (Keycloak)
provider = "oidc"
provider_display_name = "Fineract Keycloak"

# Keycloak OIDC issuer URL (internal Docker network)
oidc_issuer_url = "http://keycloak:8080/realms/fineract"

# OIDC discovery
skip_oidc_discovery = false
insecure_oidc_skip_issuer_verification = true

oidc_email_claim = "email"
oidc_groups_claim = "realm_access.roles"

# Redirect and Callback Configuration
redirect_url = "http://localhost:8080/oauth2/callback"
whitelist_domains = ["localhost", ".localhost"]

# Cookie Configuration (HTTP for local dev)
cookie_name = "_oauth2_proxy"
cookie_secure = false
cookie_httponly = true
cookie_samesite = "lax"
cookie_domains = "localhost"
cookie_expire = "4h"
cookie_refresh = "20m"

# Logout Configuration
# backend_logout_url removed - gateway /logout endpoint handles Keycloak session termination
# via top-level navigation (required for SameSite cookie policy)

# Session Configuration (Redis)
session_store_type = "redis"
# Redis connection set via env vars: OAUTH2_PROXY_REDIS_CONNECTION_URL, OAUTH2_PROXY_REDIS_PASSWORD

# Email and Authorization
email_domains = "*"

# Skip authentication for static assets and health checks
skip_auth_routes = [
  "^/ping$",
  "^/ready$",
  "^/.*\\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|map)$",
  "^/assets/.*$",
  "^/manifest\\.json$",
  "^/favicon\\.ico$",
]

# Upstream Configuration
upstreams = []

# Headers and Request Flow
set_xauthrequest = true
set_authorization_header = true
pass_authorization_header = true
pass_access_token = true
pass_user_headers = true

# Logging
logging_filename = ""
standard_logging = true
auth_logging = true
request_logging = true

# Security Configuration (relaxed for local dev)
ssl_insecure_skip_verify = true
force_https = false

# Scope Configuration
scope = "openid profile email roles offline_access"

# Metrics and Health
metrics_address = "0.0.0.0:9090"
ping_path = "/ping"
ready_path = "/ready"

# Banner
footer = "Fineract Platform - Local Development"

# Advanced
skip_jwt_bearer_tokens = false
allowed_groups = []
real_client_ip_header = "X-Forwarded-For"
silence_ping_logging = true
