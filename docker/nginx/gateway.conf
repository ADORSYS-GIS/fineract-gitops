# =============================================================================
# Gateway Nginx - Replicates K8s Ingress with OAuth2-Proxy auth_request
# =============================================================================
# Single entry point at http://localhost:8080 with path-based routing
# Unauthenticated users are redirected to Keycloak via OAuth2-Proxy
# =============================================================================

# Use Docker internal DNS for dynamic upstream resolution
resolver 127.0.0.11 valid=30s ipv6=off;

server {
    listen 80;
    server_name _;

    # Disable absolute redirects so nginx sends relative Location headers.
    # This ensures the browser keeps the correct external port (8080).
    absolute_redirect off;

    # Large headers for OAuth2 cookies/tokens
    large_client_header_buffers 4 32k;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # =========================================================================
    # OAuth2-Proxy endpoints (public, no auth required)
    # =========================================================================
    location /oauth2/ {
        set $upstream_oauth2 oauth2-proxy;
        proxy_pass http://$upstream_oauth2:4180;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Auth-Request-Redirect $request_uri;
    }

    # Internal auth check endpoint
    location = /oauth2/auth {
        internal;
        set $upstream_oauth2_auth oauth2-proxy;
        proxy_pass http://$upstream_oauth2_auth:4180/oauth2/auth;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Uri $request_uri;
    }

    # Error handler: redirect to Keycloak login via OAuth2-Proxy on 401
    error_page 401 = @error401;
    location @error401 {
        return 302 /oauth2/start?rd=$scheme://$http_host$request_uri;
    }

    # =========================================================================
    # Static assets - bypass auth (same pattern as K8s ingress)
    # =========================================================================
    location ~* ^/(home|cashier|account|administration|branch|branchmanager|reporting|accounting|self-service|mifosweb|asset-manager)/(assets|dist)/.+\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|map)$ {
        # No auth for static assets
        set $app_name $1;

        # Map path prefix to Docker service name
        set $backend "";
        if ($app_name = "cashier") { set $backend "cashier-app"; }
        if ($app_name = "account") { set $backend "account-manager-app"; }
        if ($app_name = "administration") { set $backend "admin-app"; }
        if ($app_name = "branch") { set $backend "branch-manager-app"; }
        if ($app_name = "branchmanager") { set $backend "branch-manager-app"; }
        if ($app_name = "reporting") { set $backend "reporting-app"; }
        if ($app_name = "accounting") { set $backend "accounting-app"; }
        if ($app_name = "self-service") { set $backend "self-service-app"; }
        if ($app_name = "mifosweb") { set $backend "web-app"; }
        if ($app_name = "home") { set $backend "portal-app"; }
        if ($app_name = "asset-manager") { set $backend "asset-manager-app"; }

        # Strip the prefix and proxy to the app
        rewrite ^/[^/]+/(.*) /$1 break;
        proxy_pass http://$backend:80;
        proxy_set_header Host $host;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        access_log off;
    }

    # =========================================================================
    # Frontend Apps (OAuth2 protected)
    # =========================================================================

    # Web App (Mifos)
    location /mifosweb/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_web web-app;
        rewrite ^/mifosweb/(.*) /$1 break;
        proxy_pass http://$upstream_web:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";

        # Rewrite base href so assets load under /mifosweb/ subpath
        proxy_set_header Accept-Encoding "";
        sub_filter '<base href="/">' '<base href="/mifosweb/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Cashier App
    location /cashier/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;
        auth_request_set $auth_user_cashier $upstream_http_x_auth_request_user;
        auth_request_set $auth_email_cashier $upstream_http_x_auth_request_email;
        auth_request_set $auth_groups_cashier $upstream_http_x_auth_request_groups;

        set $upstream_cashier cashier-app;
        rewrite ^/cashier/(.*) /$1 break;
        proxy_pass http://$upstream_cashier:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
        proxy_set_header X-Auth-Request-User $auth_user_cashier;
        proxy_set_header X-Auth-Request-Email $auth_email_cashier;
        proxy_set_header X-Auth-Request-Groups $auth_groups_cashier;

        # Inject base href for subpath routing
        proxy_set_header Accept-Encoding "";
        sub_filter '<head>' '<head><base href="/cashier/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Accounting App
    location /accounting/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;
        auth_request_set $auth_user_accounting $upstream_http_x_auth_request_user;
        auth_request_set $auth_email_accounting $upstream_http_x_auth_request_email;
        auth_request_set $auth_groups_accounting $upstream_http_x_auth_request_groups;

        set $upstream_accounting accounting-app;
        rewrite ^/accounting/(.*) /$1 break;
        proxy_pass http://$upstream_accounting:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
        proxy_set_header X-Auth-Request-User $auth_user_accounting;
        proxy_set_header X-Auth-Request-Email $auth_email_accounting;
        proxy_set_header X-Auth-Request-Groups $auth_groups_accounting;

        # Inject base href for subpath routing
        proxy_set_header Accept-Encoding "";
        sub_filter '<head>' '<head><base href="/accounting/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Reporting App
    location /reporting/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_reporting reporting-app;
        rewrite ^/reporting/(.*) /$1 break;
        proxy_pass http://$upstream_reporting:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";

        # Inject base href for subpath routing
        proxy_set_header Accept-Encoding "";
        sub_filter '<head>' '<head><base href="/reporting/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Admin App
    location /administration/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;
        auth_request_set $auth_user_admin $upstream_http_x_auth_request_user;
        auth_request_set $auth_email_admin $upstream_http_x_auth_request_email;
        auth_request_set $auth_groups_admin $upstream_http_x_auth_request_groups;

        set $upstream_admin admin-app;
        rewrite ^/administration/(.*) /$1 break;
        proxy_pass http://$upstream_admin:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
        proxy_set_header X-Auth-Request-User $auth_user_admin;
        proxy_set_header X-Auth-Request-Email $auth_email_admin;
        proxy_set_header X-Auth-Request-Groups $auth_groups_admin;

        # Inject base href for subpath routing
        proxy_set_header Accept-Encoding "";
        sub_filter '<head>' '<head><base href="/administration/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Account Manager App
    location /account/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_account account-manager-app;
        rewrite ^/account/(.*) /$1 break;
        proxy_pass http://$upstream_account:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";

        # Inject base href for subpath routing
        proxy_set_header Accept-Encoding "";
        sub_filter '<head>' '<head><base href="/account/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Branch Manager App
    location /branch/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_branch branch-manager-app;
        rewrite ^/branch/(.*) /$1 break;
        proxy_pass http://$upstream_branch:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";

        # Inject base href for subpath routing
        proxy_set_header Accept-Encoding "";
        sub_filter '<head>' '<head><base href="/branch/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Self-Service App (public - handles OIDC/PKCE directly, no OAuth2-Proxy)
    location /self-service/ {
        set $upstream_selfservice self-service-app;
        rewrite ^/self-service/(.*) /$1 break;
        proxy_pass http://$upstream_selfservice:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # Fineract API (OAuth2 protected)
    # =========================================================================
    location /fineract-provider/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_fineract fineract;
        proxy_pass https://$upstream_fineract:8443;
        proxy_ssl_verify off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
        proxy_set_header Fineract-Platform-TenantId $http_fineract_platform_tenantid;
    }

    # =========================================================================
    # User Sync Service API (OAuth2 protected)
    # =========================================================================
    location /api/user-sync {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_usersync user-sync-service;
        proxy_pass http://$upstream_usersync:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    # =========================================================================
    # Customer Self-Service API (OAuth2 protected)
    # Routes used by account-manager-app for KYC reviews and account queries
    # =========================================================================

    # Registration/KYC API - pass full path to customer-self-service
    location /api/registration/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_css customer-self-service;
        proxy_pass http://$upstream_css:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    # Account data API - keeps /api/accounts/ prefix
    location /api/accounts/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_css_accounts customer-self-service;
        proxy_pass http://$upstream_css_accounts:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    # Asset Manager App
    location /asset-manager/ {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_manager asset-manager-app;
        rewrite ^/asset-manager/(.*) /$1 break;
        proxy_pass http://$upstream_asset_manager:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";

        # Inject base href for subpath routing
        proxy_set_header Accept-Encoding "";
        sub_filter '<head>' '<head><base href="/asset-manager/">';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # =========================================================================
    # Asset Service API (OAuth2 protected)
    # =========================================================================
    location /api/assets {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc asset-service;
        proxy_pass http://$upstream_asset_svc:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/admin/assets {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_admin asset-service;
        proxy_pass http://$upstream_asset_svc_admin:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/admin/orderbook {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_ob asset-service;
        proxy_pass http://$upstream_asset_svc_ob:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/orderbook {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_pub_ob asset-service;
        proxy_pass http://$upstream_asset_svc_pub_ob:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/prices {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_prices asset-service;
        proxy_pass http://$upstream_asset_svc_prices:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/market {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_market asset-service;
        proxy_pass http://$upstream_asset_svc_market:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/trades {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_trades asset-service;
        proxy_pass http://$upstream_asset_svc_trades:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/portfolio {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_portfolio asset-service;
        proxy_pass http://$upstream_asset_svc_portfolio:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    location /api/favorites {
        auth_request /oauth2/auth;
        auth_request_set $access_token $upstream_http_x_auth_request_access_token;

        set $upstream_asset_svc_favs asset-service;
        proxy_pass http://$upstream_asset_svc_favs:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer $access_token";
    }

    # =========================================================================
    # Health check endpoint
    # =========================================================================
    location = /healthz {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # =========================================================================
    # Portal Home Page (public - no OAuth2 auth required)
    # =========================================================================
    location /home/ {
        set $upstream_portal portal-app;
        rewrite ^/home/(.*) /$1 break;
        proxy_pass http://$upstream_portal:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # Default - redirect to portal home page
    # =========================================================================
    location = / {
        return 302 /home/;
    }

    # =========================================================================
    # Security headers
    # =========================================================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
}
