name: Sync Fineract API Schemas

on:
  # Weekly sync every Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force rebuild of Fineract'
        required: false
        type: boolean
        default: false

jobs:
  sync-schemas:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Checkout Fineract Source
        uses: actions/checkout@v4
        with:
          repository: apache/fineract
          path: fineract-source
          fetch-depth: 1

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Build Fineract to Generate OpenAPI Spec
        working-directory: fineract-source
        run: |
          echo "Building Fineract to generate OpenAPI specification..."
          ./gradlew :fineract-provider:build -x test -x integrationTest --no-daemon

          # Verify OpenAPI spec was generated
          if [ ! -f "fineract-provider/build/classes/java/main/static/fineract.json" ]; then
            echo "Error: OpenAPI spec not generated"
            exit 1
          fi

          echo "OpenAPI spec generated successfully"
          ls -lh fineract-provider/build/classes/java/main/static/fineract.json

      - name: Copy OpenAPI Spec to GitOps Repository
        run: |
          # Create schema directory if it doesn't exist
          mkdir -p operations/fineract-data/schemas

          # Copy OpenAPI spec
          cp fineract-source/fineract-provider/build/classes/java/main/static/fineract.json \
             operations/fineract-data/schemas/fineract-openapi.json

          echo "OpenAPI spec copied to operations/fineract-data/schemas/fineract-openapi.json"

      - name: Check for Schema Changes
        id: check_changes
        run: |
          if git diff --quiet operations/fineract-data/schemas/fineract-openapi.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No schema changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Schema changes detected!"

            # Get diff stats
            echo "## Changes Summary" >> $GITHUB_STEP_SUMMARY
            git diff --stat operations/fineract-data/schemas/fineract-openapi.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Get Fineract Version Info
        if: steps.check_changes.outputs.has_changes == 'true'
        id: fineract_info
        working-directory: fineract-source
        run: |
          # Get latest commit info
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=short)
          COMMIT_MSG=$(git log -1 --format=%s)

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT

          echo "Fineract version: $COMMIT_SHA ($COMMIT_DATE)"

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: sync Fineract API schema from upstream

            Automated sync from Apache Fineract repository.

            Fineract commit: ${{ steps.fineract_info.outputs.commit_sha }}
            Fineract date: ${{ steps.fineract_info.outputs.commit_date }}
            Latest change: ${{ steps.fineract_info.outputs.commit_msg }}
          branch: sync/fineract-schemas-${{ github.run_number }}
          delete-branch: true
          title: "[Auto] Update Fineract API Schemas"
          body: |
            ## Fineract API Schema Update

            This PR contains an automated sync of the Fineract OpenAPI schema from the upstream Apache Fineract repository.

            ### Fineract Version Info
            - **Commit**: ${{ steps.fineract_info.outputs.commit_sha }}
            - **Date**: ${{ steps.fineract_info.outputs.commit_date }}
            - **Latest Change**: ${{ steps.fineract_info.outputs.commit_msg }}

            ### Review Checklist

            Before merging, please review the following:

            - [ ] Check for breaking API changes (removed endpoints, changed request/response schemas)
            - [ ] Verify new endpoints are compatible with existing YAML data structures
            - [ ] Check if any loader scripts need updates for new/changed fields
            - [ ] Review changes to existing entity schemas (GLAccount, LoanProduct, etc.)
            - [ ] Ensure enum values and data types are still compatible
            - [ ] Check for deprecated endpoints that we're currently using

            ### Next Steps

            1. **Review Schema Changes**:
               ```bash
               git diff operations/fineract-data/schemas/fineract-openapi.json
               ```

            2. **Test Locally** (if needed):
               ```bash
               cd operations/fineract-data
               # Run loaders against dev environment to test compatibility
               ```

            3. **Update Loaders** (if needed):
               - If API changes require loader updates, create follow-up issues
               - Document breaking changes in REFACTOR_PLAN.md

            4. **Merge**: If no breaking changes or all compatibility issues are addressed

            ### Automated Sync Info

            - **Workflow**: `.github/workflows/sync-fineract-schemas.yml`
            - **Schedule**: Weekly on Mondays at 9 AM UTC
            - **Manual Trigger**: Available via workflow_dispatch

            ---

            ðŸ¤– This PR was created automatically by the schema sync workflow.
          labels: |
            schema-sync
            automated
            needs-review
          assignees: guymoyo
          draft: false

      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Schema changes detected and PR created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with the updated Fineract API schema." >> $GITHUB_STEP_SUMMARY
            echo "Please review the changes before merging." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Schema is up to date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes detected in the Fineract API schema." >> $GITHUB_STEP_SUMMARY
          fi
