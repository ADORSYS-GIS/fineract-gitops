name: Validate Secrets

on:
  pull_request:
    paths:
      - 'apps/**/secret*.yaml'
      - 'secrets/**/*.yaml'
      - '**/*secret*.yaml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/**/secret*.yaml'
      - 'secrets/**/*.yaml'
      - '**/*secret*.yaml'

jobs:
  check-plaintext-secrets:
    name: Check for Plaintext Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for plaintext secrets in apps/ directory
        run: |
          echo "üîç Checking for plaintext secrets in apps/ directory..."

          # Find all secret*.yaml files in apps/ directory
          secret_files=$(find apps/ -name "secret*.yaml" -type f 2>/dev/null || true)

          if [ -n "$secret_files" ]; then
            echo "‚ùå ERROR: Found plaintext secret files in apps/ directory!"
            echo "These files should be removed and replaced with SealedSecrets:"
            echo "$secret_files"
            echo ""
            echo "Please:"
            echo "1. Create encrypted secrets using kubeseal"
            echo "2. Place them in secrets/{dev,uat,production}/ directory"
            echo "3. Remove the plaintext secret files from apps/"
            exit 1
          else
            echo "‚úÖ No plaintext secrets found in apps/ directory"
          fi

      - name: Check for unencrypted secrets in secrets/ directory
        run: |
          echo "üîç Checking for unencrypted secrets in secrets/ directory..."

          # Find YAML files that are NOT templates and NOT sealed secrets
          unencrypted=$(find secrets/ -name "*.yaml" \
            ! -name "*.template.yaml" \
            ! -name "*-sealedsecret.yaml" \
            ! -name ".gitkeep" \
            -type f 2>/dev/null || true)

          if [ -n "$unencrypted" ]; then
            echo "‚ùå ERROR: Found unencrypted secret files in secrets/ directory!"
            echo "These files should be encrypted with kubeseal:"
            echo "$unencrypted"
            echo ""
            echo "To encrypt:"
            echo "  kubeseal --format yaml < secret.yaml > secret-sealedsecret.yaml"
            echo "  rm secret.yaml"
            exit 1
          else
            echo "‚úÖ No unencrypted secrets found in secrets/ directory"
          fi

      - name: Check for common password patterns
        run: |
          echo "üîç Checking for common password patterns..."

          # Search for common weak password patterns
          if grep -r -E "(changeme|CHANGE_ME|password.*:|123456|admin123)" \
            apps/ secrets/ --include="*.yaml" 2>/dev/null | \
            grep -v "template.yaml" | \
            grep -v "# " | \
            grep -v "\.md:" ; then
            echo "‚ùå ERROR: Found potential plaintext passwords!"
            echo "Please use encrypted SealedSecrets instead"
            exit 1
          else
            echo "‚úÖ No common password patterns found"
          fi

      - name: Validate SealedSecret format
        run: |
          echo "üîç Validating SealedSecret format..."

          # Find all SealedSecret files
          sealed_secrets=$(find secrets/ -name "*-sealedsecret.yaml" -type f 2>/dev/null || true)

          if [ -z "$sealed_secrets" ]; then
            echo "‚ö†Ô∏è  WARNING: No SealedSecret files found"
            echo "This is expected if you haven't created any secrets yet"
            exit 0
          fi

          for file in $sealed_secrets; do
            echo "Checking $file..."

            # Check if file contains required SealedSecret fields
            if ! grep -q "kind: SealedSecret" "$file"; then
              echo "‚ùå ERROR: $file is not a valid SealedSecret (missing 'kind: SealedSecret')"
              exit 1
            fi

            if ! grep -q "bitnami.com" "$file"; then
              echo "‚ùå ERROR: $file is not a valid SealedSecret (missing bitnami.com group)"
              exit 1
            fi

            # Check if file contains encrypted data
            if ! grep -q "encryptedData:" "$file"; then
              echo "‚ùå ERROR: $file does not contain encrypted data"
              exit 1
            fi

            echo "‚úÖ $file is valid"
          done

          echo "‚úÖ All SealedSecrets are valid"

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ All secret validation checks passed!"
          echo ""
          echo "Summary:"
          echo "- No plaintext secrets in apps/ directory"
          echo "- No unencrypted secrets in secrets/ directory"
          echo "- No common password patterns found"
          echo "- All SealedSecrets are properly formatted"
